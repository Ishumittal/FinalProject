import { __decorate, __param } from "tslib";
import { Inject, Optional } from '@angular/core';
import { NX_DATE_LOCALE, NxDateAdapter } from '@aposin/ng-aquila/datefield';
import { pad } from '@aposin/ng-aquila/utils';
import dayjs from 'dayjs';
import customParseFormat from 'dayjs/plugin/customParseFormat';
import localeData from 'dayjs/plugin/localeData';
import localizedFormat from 'dayjs/plugin/localizedFormat';
import utc from 'dayjs/plugin/utc';
import { convertToDayjsLocale, getDayjsLocaleData } from './dayjs-locale-utils';
dayjs.extend(localeData);
dayjs.extend(customParseFormat);
dayjs.extend(localizedFormat);
dayjs.extend(utc);
const ISO_STRING_FORMAT = 'YYYY-MM-DD';
const ISO_REGEX = /^(\d{4})(-?)(1[0-2]|0[1-9])\2(3[01]|0[1-9]|[12]\d)$/;
/** Creates an array and fills it with values. */
function range(length, valueFunction) {
    const valuesArray = Array(length);
    for (let i = 0; i < length; i++) {
        valuesArray[i] = valueFunction(i);
    }
    return valuesArray;
}
/**
 * @docs-private
 */
let NxIsoDateAdapter = class NxIsoDateAdapter extends NxDateAdapter {
    constructor(dateLocale) {
        super();
        this.setLocale(dateLocale || dayjs.locale());
    }
    toIso8601(date) {
        return dayjs.utc(date).format();
    }
    deserialize(value) {
        let date;
        // TODO should we accept that or only take strings?
        if (value instanceof Date) {
            date = dayjs(value).locale(this._dayjsLocale);
        }
        if (typeof value === 'string') {
            if (!value) {
                return null;
            }
            date = dayjs(value).locale(this._dayjsLocale);
        }
        if (date && this.isValid(date.toString())) {
            return dayjs(date).locale(this._dayjsLocale).format(ISO_STRING_FORMAT);
        }
        return super.deserialize(value);
    }
    format(date, displayFormat) {
        return this._createDayjs(date).format(displayFormat);
    }
    /**
     * if the given formats include a localized format we have to map
     * it manually to a dayjs format as dayjs recognizes locale
     * format only for formatting not for parsing
     * see https://github.com/iamkun/dayjs/issues/694#issuecomment-543209946
     */
    normalizeFormat(format) {
        const availableLocalFormats = dayjs.Ls[this._dayjsLocale]?.formats;
        if (!availableLocalFormats) {
            throw new Error(`NxIsoDateAdapter: The used locale "${this._dayjsLocale}" is not available in this day.js instance. Please make sure the locale is imported.`);
        }
        let normalizedFormat = format;
        if (!Array.isArray(normalizedFormat)) {
            normalizedFormat = [normalizedFormat];
        }
        normalizedFormat = normalizedFormat.map(formatString => {
            if (Object.keys(availableLocalFormats).includes(formatString)) {
                return availableLocalFormats[formatString];
            }
            return formatString;
        });
        return normalizedFormat;
    }
    parse(value, format, strict) {
        let obj;
        const normalizedFormats = this.normalizeFormat(format);
        if (value && typeof value === 'string') {
            if (strict) {
                obj = dayjs(value, normalizedFormats, this._dayjsLocale, true);
            }
            else {
                // The non strict parsing of day.js is rather strict when it comes to separators.
                // For example, this format: YYYY-MM-DD still requires the user to type in the -
                // To get a little closer to the behavior of momentjs, the following code extends
                // the list of given formats with versions were all the separators were removed
                const formatsWithoutSeparators = [...normalizedFormats].map(normalizedformat => normalizedformat.replace(/\W/g, ''));
                obj = dayjs(value, [...formatsWithoutSeparators, ...normalizedFormats], this._dayjsLocale, false);
            }
        }
        if (!obj?.isValid()) {
            return '';
        }
        return obj ? obj.format(ISO_STRING_FORMAT) : '';
    }
    isValid(date) {
        return dayjs(date).isValid();
    }
    clone(date) {
        return date;
    }
    isDateInstance(obj) {
        return obj === '' || (typeof obj === 'string' && ISO_REGEX.test(obj));
    }
    invalid() {
        return '';
    }
    getYear(date) {
        return this._createDayjs(date).year();
    }
    getMonth(date) {
        return this._createDayjs(date).month();
    }
    getDate(date) {
        return this._createDayjs(date).date();
    }
    getYearName(date) {
        return this._createDayjs(date).format('YYYY');
    }
    createDate(year, month, date) {
        // Check for invalid month and date (except upper bound on date which we have to check after
        // creating the Date).
        if (month < 0 || month > 11) {
            throw Error(`Invalid month index "${month}". Month index has to be between 0 and 11.`);
        }
        if (date < 1) {
            throw Error(`Invalid date "${date}". Date has to be greater than 0.`);
        }
        // dayjs adds overflows up instead of creating invalid dates so we have to check that here
        const obj = this._createDayjs(this._createString(year, month + 1, date));
        // Check that the date wasn't above the upper bound for the month, causing the month to overflow
        if (obj.month() !== month || obj.year() !== year) {
            throw Error(`Invalid date "${date}" for month with index "${month}".`);
        }
        return obj.format(ISO_STRING_FORMAT);
    }
    getNumDaysInMonth(date) {
        return this._createDayjs(date).daysInMonth();
    }
    getDateNames() {
        return this._localeData.dates;
    }
    getDayOfWeek(date) {
        return this._createDayjs(date).day();
    }
    getFirstDayOfWeek() {
        return this._localeData.firstDayOfWeek;
    }
    getMonthNames(style) {
        return style === 'long' ? this._localeData.longMonths : this._localeData.shortMonths;
    }
    today() {
        return dayjs().format(ISO_STRING_FORMAT);
    }
    addCalendarMonths(date, months) {
        return this._createDayjs(date).add(months, 'M').format(ISO_STRING_FORMAT);
    }
    addCalendarYears(date, years) {
        return this._createDayjs(date).add(years, 'y').format(ISO_STRING_FORMAT);
    }
    addCalendarDays(date, days) {
        return this._createDayjs(date).add(days, 'd').format(ISO_STRING_FORMAT);
    }
    getDayOfWeekNames(style) {
        if (style === 'long') {
            return this._localeData.longDaysOfWeek;
        }
        if (style === 'short') {
            return this._localeData.shortDaysOfWeek;
        }
        return this._localeData.narrowDaysOfWeek;
    }
    async setLocale(locale) {
        this._dayjsLocale = convertToDayjsLocale(locale);
        const data = await getDayjsLocaleData(this._dayjsLocale);
        this._localeData = {
            firstDayOfWeek: data.firstDayOfWeek(),
            longMonths: data.months(),
            shortMonths: data.monthsShort(),
            dates: range(31, i => this._createDayjs(this.createDate(2017, 0, i + 1)).format('D')),
            longDaysOfWeek: data.weekdays(),
            shortDaysOfWeek: data.weekdaysShort(),
            narrowDaysOfWeek: data.weekdaysMin(),
        };
        super.setLocale(locale);
    }
    _createDayjs(value) {
        return dayjs.utc(value).locale(this._dayjsLocale);
    }
    _createString(year, month, date) {
        return `${year}-${pad(month.toString())}-${pad(date.toString())}`;
    }
};
NxIsoDateAdapter = __decorate([
    __param(0, Optional()),
    __param(0, Inject(NX_DATE_LOCALE))
], NxIsoDateAdapter);
export { NxIsoDateAdapter };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXNvLWRhdGUtYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWFxdWlsYS9zcmMvaXNvLWRhdGUtYWRhcHRlci9hZGFwdGVyL2lzby1kYXRlLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDNUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlDLE9BQU8sS0FBZ0IsTUFBTSxPQUFPLENBQUM7QUFDckMsT0FBTyxpQkFBaUIsTUFBTSxnQ0FBZ0MsQ0FBQztBQUMvRCxPQUFPLFVBQVUsTUFBTSx5QkFBeUIsQ0FBQztBQUNqRCxPQUFPLGVBQWUsTUFBTSw4QkFBOEIsQ0FBQztBQUMzRCxPQUFPLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQztBQUVuQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVoRixLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3pCLEtBQUssQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUNoQyxLQUFLLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzlCLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7QUFFbEIsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUM7QUFDdkMsTUFBTSxTQUFTLEdBQUcscURBQXFELENBQUM7QUFFeEUsaURBQWlEO0FBQ2pELFNBQVMsS0FBSyxDQUFJLE1BQWMsRUFBRSxhQUFtQztJQUNqRSxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsS0FBSyxJQUFJLENBQUMsR0FB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UUFBUSxFQUFFO1lBQy9CLGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3JDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUU7U0FDdkMsQ0FBQztRQUVGLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVPLFlBQVksQ0FBQyxLQUFhO1FBQzlCLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFTyxhQUFhLENBQUMsSUFBWSxFQUFFLEtBQWEsRUFBRSxJQUFZO1FBQzNELE9BQU8sR0FBRyxJQUFJLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3RFLENBQUM7Q0FDSixDQUFBO0FBaE9ZLGdCQUFnQjtJQWFaLFdBQUEsUUFBUSxFQUFFLENBQUE7SUFBRSxXQUFBLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQTtHQWJ0QyxnQkFBZ0IsQ0FnTzVCO1NBaE9ZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5YX0RBVEVfTE9DQUxFLCBOeERhdGVBZGFwdGVyIH0gZnJvbSAnQGFwb3Npbi9uZy1hcXVpbGEvZGF0ZWZpZWxkJztcbmltcG9ydCB7IHBhZCB9IGZyb20gJ0BhcG9zaW4vbmctYXF1aWxhL3V0aWxzJztcbmltcG9ydCBkYXlqcywgeyBEYXlqcyB9IGZyb20gJ2RheWpzJztcbmltcG9ydCBjdXN0b21QYXJzZUZvcm1hdCBmcm9tICdkYXlqcy9wbHVnaW4vY3VzdG9tUGFyc2VGb3JtYXQnO1xuaW1wb3J0IGxvY2FsZURhdGEgZnJvbSAnZGF5anMvcGx1Z2luL2xvY2FsZURhdGEnO1xuaW1wb3J0IGxvY2FsaXplZEZvcm1hdCBmcm9tICdkYXlqcy9wbHVnaW4vbG9jYWxpemVkRm9ybWF0JztcbmltcG9ydCB1dGMgZnJvbSAnZGF5anMvcGx1Z2luL3V0Yyc7XG5cbmltcG9ydCB7IGNvbnZlcnRUb0RheWpzTG9jYWxlLCBnZXREYXlqc0xvY2FsZURhdGEgfSBmcm9tICcuL2RheWpzLWxvY2FsZS11dGlscyc7XG5cbmRheWpzLmV4dGVuZChsb2NhbGVEYXRhKTtcbmRheWpzLmV4dGVuZChjdXN0b21QYXJzZUZvcm1hdCk7XG5kYXlqcy5leHRlbmQobG9jYWxpemVkRm9ybWF0KTtcbmRheWpzLmV4dGVuZCh1dGMpO1xuXG5jb25zdCBJU09fU1RSSU5HX0ZPUk1BVCA9ICdZWVlZLU1NLUREJztcbmNvbnN0IElTT19SRUdFWCA9IC9eKFxcZHs0fSkoLT8pKDFbMC0yXXwwWzEtOV0pXFwyKDNbMDFdfDBbMS05XXxbMTJdXFxkKSQvO1xuXG4vKiogQ3JlYXRlcyBhbiBhcnJheSBhbmQgZmlsbHMgaXQgd2l0aCB2YWx1ZXMuICovXG5mdW5jdGlvbiByYW5nZTxUPihsZW5ndGg6IG51bWJlciwgdmFsdWVGdW5jdGlvbjogKGluZGV4OiBudW1iZXIpID0+IFQpOiBUW10ge1xuICAgIGNvbnN0IHZhbHVlc0FycmF5ID0gQXJyYXkobGVuZ3RoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhbHVlc0FycmF5W2ldID0gdmFsdWVGdW5jdGlvbihpKTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlc0FycmF5O1xufVxuXG4vKipcbiAqIEBkb2NzLXByaXZhdGVcbiAqL1xuZXhwb3J0IGNsYXNzIE54SXNvRGF0ZUFkYXB0ZXIgZXh0ZW5kcyBOeERhdGVBZGFwdGVyPHN0cmluZz4ge1xuICAgIHByaXZhdGUgX2xvY2FsZURhdGEhOiB7XG4gICAgICAgIGZpcnN0RGF5T2ZXZWVrOiBudW1iZXI7XG4gICAgICAgIGxvbmdNb250aHM6IHN0cmluZ1tdO1xuICAgICAgICBzaG9ydE1vbnRoczogc3RyaW5nW107XG4gICAgICAgIGRhdGVzOiBzdHJpbmdbXTtcbiAgICAgICAgbG9uZ0RheXNPZldlZWs6IHN0cmluZ1tdO1xuICAgICAgICBzaG9ydERheXNPZldlZWs6IHN0cmluZ1tdO1xuICAgICAgICBuYXJyb3dEYXlzT2ZXZWVrOiBzdHJpbmdbXTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBfZGF5anNMb2NhbGUhOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KE5YX0RBVEVfTE9DQUxFKSBkYXRlTG9jYWxlOiBzdHJpbmcgfCBudWxsKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuc2V0TG9jYWxlKGRhdGVMb2NhbGUgfHwgZGF5anMubG9jYWxlKCkpO1xuICAgIH1cblxuICAgIHRvSXNvODYwMShkYXRlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gZGF5anMudXRjKGRhdGUpLmZvcm1hdCgpO1xuICAgIH1cblxuICAgIGRlc2VyaWFsaXplKHZhbHVlOiBhbnkpOiBzdHJpbmcgfCBudWxsIHtcbiAgICAgICAgbGV0IGRhdGU7XG5cbiAgICAgICAgLy8gVE9ETyBzaG91bGQgd2UgYWNjZXB0IHRoYXQgb3Igb25seSB0YWtlIHN0cmluZ3M/XG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgIGRhdGUgPSBkYXlqcyh2YWx1ZSkubG9jYWxlKHRoaXMuX2RheWpzTG9jYWxlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGF0ZSA9IGRheWpzKHZhbHVlKS5sb2NhbGUodGhpcy5fZGF5anNMb2NhbGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGUgJiYgdGhpcy5pc1ZhbGlkKGRhdGUudG9TdHJpbmcoKSkpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXlqcyhkYXRlKS5sb2NhbGUodGhpcy5fZGF5anNMb2NhbGUpLmZvcm1hdChJU09fU1RSSU5HX0ZPUk1BVCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3VwZXIuZGVzZXJpYWxpemUodmFsdWUpO1xuICAgIH1cblxuICAgIGZvcm1hdChkYXRlOiBzdHJpbmcsIGRpc3BsYXlGb3JtYXQ6IGFueSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVEYXlqcyhkYXRlKS5mb3JtYXQoZGlzcGxheUZvcm1hdCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaWYgdGhlIGdpdmVuIGZvcm1hdHMgaW5jbHVkZSBhIGxvY2FsaXplZCBmb3JtYXQgd2UgaGF2ZSB0byBtYXBcbiAgICAgKiBpdCBtYW51YWxseSB0byBhIGRheWpzIGZvcm1hdCBhcyBkYXlqcyByZWNvZ25pemVzIGxvY2FsZVxuICAgICAqIGZvcm1hdCBvbmx5IGZvciBmb3JtYXR0aW5nIG5vdCBmb3IgcGFyc2luZ1xuICAgICAqIHNlZSBodHRwczovL2dpdGh1Yi5jb20vaWFta3VuL2RheWpzL2lzc3Vlcy82OTQjaXNzdWVjb21tZW50LTU0MzIwOTk0NlxuICAgICAqL1xuICAgIG5vcm1hbGl6ZUZvcm1hdChmb3JtYXQ6IHN0cmluZyB8IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBhdmFpbGFibGVMb2NhbEZvcm1hdHM6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSBkYXlqcy5Mc1t0aGlzLl9kYXlqc0xvY2FsZV0/LmZvcm1hdHM7XG4gICAgICAgIGlmICghYXZhaWxhYmxlTG9jYWxGb3JtYXRzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYE54SXNvRGF0ZUFkYXB0ZXI6IFRoZSB1c2VkIGxvY2FsZSBcIiR7dGhpcy5fZGF5anNMb2NhbGV9XCIgaXMgbm90IGF2YWlsYWJsZSBpbiB0aGlzIGRheS5qcyBpbnN0YW5jZS4gUGxlYXNlIG1ha2Ugc3VyZSB0aGUgbG9jYWxlIGlzIGltcG9ydGVkLmAsXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGxldCBub3JtYWxpemVkRm9ybWF0ID0gZm9ybWF0O1xuXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShub3JtYWxpemVkRm9ybWF0KSkge1xuICAgICAgICAgICAgbm9ybWFsaXplZEZvcm1hdCA9IFtub3JtYWxpemVkRm9ybWF0XTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5vcm1hbGl6ZWRGb3JtYXQgPSBub3JtYWxpemVkRm9ybWF0Lm1hcChmb3JtYXRTdHJpbmcgPT4ge1xuICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGF2YWlsYWJsZUxvY2FsRm9ybWF0cykuaW5jbHVkZXMoZm9ybWF0U3RyaW5nKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhdmFpbGFibGVMb2NhbEZvcm1hdHNbZm9ybWF0U3RyaW5nXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGZvcm1hdFN0cmluZztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZWRGb3JtYXQ7XG4gICAgfVxuXG4gICAgcGFyc2UodmFsdWU6IGFueSwgZm9ybWF0OiBzdHJpbmcgfCBzdHJpbmdbXSwgc3RyaWN0OiBib29sZWFuKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IG9iaiE6IERheWpzO1xuXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRGb3JtYXRzID0gdGhpcy5ub3JtYWxpemVGb3JtYXQoZm9ybWF0KTtcbiAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGlmIChzdHJpY3QpIHtcbiAgICAgICAgICAgICAgICBvYmogPSBkYXlqcyh2YWx1ZSwgbm9ybWFsaXplZEZvcm1hdHMsIHRoaXMuX2RheWpzTG9jYWxlLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gVGhlIG5vbiBzdHJpY3QgcGFyc2luZyBvZiBkYXkuanMgaXMgcmF0aGVyIHN0cmljdCB3aGVuIGl0IGNvbWVzIHRvIHNlcGFyYXRvcnMuXG4gICAgICAgICAgICAgICAgLy8gRm9yIGV4YW1wbGUsIHRoaXMgZm9ybWF0OiBZWVlZLU1NLUREIHN0aWxsIHJlcXVpcmVzIHRoZSB1c2VyIHRvIHR5cGUgaW4gdGhlIC1cbiAgICAgICAgICAgICAgICAvLyBUbyBnZXQgYSBsaXR0bGUgY2xvc2VyIHRvIHRoZSBiZWhhdmlvciBvZiBtb21lbnRqcywgdGhlIGZvbGxvd2luZyBjb2RlIGV4dGVuZHNcbiAgICAgICAgICAgICAgICAvLyB0aGUgbGlzdCBvZiBnaXZlbiBmb3JtYXRzIHdpdGggdmVyc2lvbnMgd2VyZSBhbGwgdGhlIHNlcGFyYXRvcnMgd2VyZSByZW1vdmVkXG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybWF0c1dpdGhvdXRTZXBhcmF0b3JzID0gWy4uLm5vcm1hbGl6ZWRGb3JtYXRzXS5tYXAobm9ybWFsaXplZGZvcm1hdCA9PiBub3JtYWxpemVkZm9ybWF0LnJlcGxhY2UoL1xcVy9nLCAnJykpO1xuICAgICAgICAgICAgICAgIG9iaiA9IGRheWpzKHZhbHVlLCBbLi4uZm9ybWF0c1dpdGhvdXRTZXBhcmF0b3JzLCAuLi5ub3JtYWxpemVkRm9ybWF0c10sIHRoaXMuX2RheWpzTG9jYWxlLCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIW9iaj8uaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb2JqID8gb2JqLmZvcm1hdChJU09fU1RSSU5HX0ZPUk1BVCkgOiAnJztcbiAgICB9XG5cbiAgICBpc1ZhbGlkKGRhdGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZGF5anMoZGF0ZSkuaXNWYWxpZCgpO1xuICAgIH1cblxuICAgIGNsb25lKGRhdGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBkYXRlO1xuICAgIH1cblxuICAgIGlzRGF0ZUluc3RhbmNlKG9iajogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBvYmogPT09ICcnIHx8ICh0eXBlb2Ygb2JqID09PSAnc3RyaW5nJyAmJiBJU09fUkVHRVgudGVzdChvYmopKTtcbiAgICB9XG5cbiAgICBpbnZhbGlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICBnZXRZZWFyKGRhdGU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVEYXlqcyhkYXRlKS55ZWFyKCk7XG4gICAgfVxuXG4gICAgZ2V0TW9udGgoZGF0ZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZURheWpzKGRhdGUpLm1vbnRoKCk7XG4gICAgfVxuXG4gICAgZ2V0RGF0ZShkYXRlOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fY3JlYXRlRGF5anMoZGF0ZSkuZGF0ZSgpO1xuICAgIH1cblxuICAgIGdldFllYXJOYW1lKGRhdGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVEYXlqcyhkYXRlKS5mb3JtYXQoJ1lZWVknKTtcbiAgICB9XG5cbiAgICBjcmVhdGVEYXRlKHllYXI6IG51bWJlciwgbW9udGg6IG51bWJlciwgZGF0ZTogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgLy8gQ2hlY2sgZm9yIGludmFsaWQgbW9udGggYW5kIGRhdGUgKGV4Y2VwdCB1cHBlciBib3VuZCBvbiBkYXRlIHdoaWNoIHdlIGhhdmUgdG8gY2hlY2sgYWZ0ZXJcbiAgICAgICAgLy8gY3JlYXRpbmcgdGhlIERhdGUpLlxuICAgICAgICBpZiAobW9udGggPCAwIHx8IG1vbnRoID4gMTEpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKGBJbnZhbGlkIG1vbnRoIGluZGV4IFwiJHttb250aH1cIi4gTW9udGggaW5kZXggaGFzIHRvIGJlIGJldHdlZW4gMCBhbmQgMTEuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0ZSA8IDEpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKGBJbnZhbGlkIGRhdGUgXCIke2RhdGV9XCIuIERhdGUgaGFzIHRvIGJlIGdyZWF0ZXIgdGhhbiAwLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZGF5anMgYWRkcyBvdmVyZmxvd3MgdXAgaW5zdGVhZCBvZiBjcmVhdGluZyBpbnZhbGlkIGRhdGVzIHNvIHdlIGhhdmUgdG8gY2hlY2sgdGhhdCBoZXJlXG4gICAgICAgIGNvbnN0IG9iaiA9IHRoaXMuX2NyZWF0ZURheWpzKHRoaXMuX2NyZWF0ZVN0cmluZyh5ZWFyLCBtb250aCArIDEsIGRhdGUpKTtcbiAgICAgICAgLy8gQ2hlY2sgdGhhdCB0aGUgZGF0ZSB3YXNuJ3QgYWJvdmUgdGhlIHVwcGVyIGJvdW5kIGZvciB0aGUgbW9udGgsIGNhdXNpbmcgdGhlIG1vbnRoIHRvIG92ZXJmbG93XG4gICAgICAgIGlmIChvYmoubW9udGgoKSAhPT0gbW9udGggfHwgb2JqLnllYXIoKSAhPT0geWVhcikge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoYEludmFsaWQgZGF0ZSBcIiR7ZGF0ZX1cIiBmb3IgbW9udGggd2l0aCBpbmRleCBcIiR7bW9udGh9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb2JqLmZvcm1hdChJU09fU1RSSU5HX0ZPUk1BVCk7XG4gICAgfVxuXG4gICAgZ2V0TnVtRGF5c0luTW9udGgoZGF0ZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZURheWpzKGRhdGUpLmRheXNJbk1vbnRoKCk7XG4gICAgfVxuXG4gICAgZ2V0RGF0ZU5hbWVzKCk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xvY2FsZURhdGEuZGF0ZXM7XG4gICAgfVxuXG4gICAgZ2V0RGF5T2ZXZWVrKGRhdGU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVEYXlqcyhkYXRlKS5kYXkoKTtcbiAgICB9XG5cbiAgICBnZXRGaXJzdERheU9mV2VlaygpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlRGF0YS5maXJzdERheU9mV2VlaztcbiAgICB9XG5cbiAgICBnZXRNb250aE5hbWVzKHN0eWxlOiAnbG9uZycgfCAnc2hvcnQnIHwgJ25hcnJvdycpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiBzdHlsZSA9PT0gJ2xvbmcnID8gdGhpcy5fbG9jYWxlRGF0YS5sb25nTW9udGhzIDogdGhpcy5fbG9jYWxlRGF0YS5zaG9ydE1vbnRocztcbiAgICB9XG5cbiAgICB0b2RheSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gZGF5anMoKS5mb3JtYXQoSVNPX1NUUklOR19GT1JNQVQpO1xuICAgIH1cblxuICAgIGFkZENhbGVuZGFyTW9udGhzKGRhdGU6IHN0cmluZywgbW9udGhzOiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fY3JlYXRlRGF5anMoZGF0ZSkuYWRkKG1vbnRocywgJ00nKS5mb3JtYXQoSVNPX1NUUklOR19GT1JNQVQpO1xuICAgIH1cblxuICAgIGFkZENhbGVuZGFyWWVhcnMoZGF0ZTogc3RyaW5nLCB5ZWFyczogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZURheWpzKGRhdGUpLmFkZCh5ZWFycywgJ3knKS5mb3JtYXQoSVNPX1NUUklOR19GT1JNQVQpO1xuICAgIH1cblxuICAgIGFkZENhbGVuZGFyRGF5cyhkYXRlOiBzdHJpbmcsIGRheXM6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVEYXlqcyhkYXRlKS5hZGQoZGF5cywgJ2QnKS5mb3JtYXQoSVNPX1NUUklOR19GT1JNQVQpO1xuICAgIH1cblxuICAgIGdldERheU9mV2Vla05hbWVzKHN0eWxlOiAnbG9uZycgfCAnc2hvcnQnIHwgJ25hcnJvdycpOiBzdHJpbmdbXSB7XG4gICAgICAgIGlmIChzdHlsZSA9PT0gJ2xvbmcnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlRGF0YS5sb25nRGF5c09mV2VlaztcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3R5bGUgPT09ICdzaG9ydCcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sb2NhbGVEYXRhLnNob3J0RGF5c09mV2VlaztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fbG9jYWxlRGF0YS5uYXJyb3dEYXlzT2ZXZWVrO1xuICAgIH1cblxuICAgIGFzeW5jIHNldExvY2FsZShsb2NhbGU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9kYXlqc0xvY2FsZSA9IGNvbnZlcnRUb0RheWpzTG9jYWxlKGxvY2FsZSk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBnZXREYXlqc0xvY2FsZURhdGEodGhpcy5fZGF5anNMb2NhbGUpO1xuXG4gICAgICAgIHRoaXMuX2xvY2FsZURhdGEgPSB7XG4gICAgICAgICAgICBmaXJzdERheU9mV2VlazogZGF0YS5maXJzdERheU9mV2VlaygpLFxuICAgICAgICAgICAgbG9uZ01vbnRoczogZGF0YS5tb250aHMoKSxcbiAgICAgICAgICAgIHNob3J0TW9udGhzOiBkYXRhLm1vbnRoc1Nob3J0KCksXG4gICAgICAgICAgICBkYXRlczogcmFuZ2UoMzEsIGkgPT4gdGhpcy5fY3JlYXRlRGF5anModGhpcy5jcmVhdGVEYXRlKDIwMTcsIDAsIGkgKyAxKSkuZm9ybWF0KCdEJykpLFxuICAgICAgICAgICAgbG9uZ0RheXNPZldlZWs6IGRhdGEud2Vla2RheXMoKSxcbiAgICAgICAgICAgIHNob3J0RGF5c09mV2VlazogZGF0YS53ZWVrZGF5c1Nob3J0KCksXG4gICAgICAgICAgICBuYXJyb3dEYXlzT2ZXZWVrOiBkYXRhLndlZWtkYXlzTWluKCksXG4gICAgICAgIH07XG5cbiAgICAgICAgc3VwZXIuc2V0TG9jYWxlKGxvY2FsZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY3JlYXRlRGF5anModmFsdWU6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gZGF5anMudXRjKHZhbHVlKS5sb2NhbGUodGhpcy5fZGF5anNMb2NhbGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZVN0cmluZyh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIsIGRhdGU6IG51bWJlcikge1xuICAgICAgICByZXR1cm4gYCR7eWVhcn0tJHtwYWQobW9udGgudG9TdHJpbmcoKSl9LSR7cGFkKGRhdGUudG9TdHJpbmcoKSl9YDtcbiAgICB9XG59XG4iXX0=