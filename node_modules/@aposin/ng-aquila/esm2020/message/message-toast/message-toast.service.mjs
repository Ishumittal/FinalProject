import { OverlayConfig } from '@angular/cdk/overlay';
import { ComponentPortal, PortalInjector, TemplatePortal } from '@angular/cdk/portal';
import { Inject, Injectable, InjectionToken, Optional, SkipSelf } from '@angular/core';
import { NxMessageModule } from '../message.module';
import { NxMessageToastComponent } from './message-toast.component';
import { NxMessageToastConfig, NxMessageToastData } from './message-toast-config';
import { NxMessageToastRef } from './message-toast-ref';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "@angular/cdk/a11y";
import * as i3 from "./message-toast-config";
/** Injection token that can be used to specify default message toast. */
export const NX_MESSAGE_TOAST_DEFAULT_CONFIG = new InjectionToken('NX_MESSAGE_TOAST_DEFAULT_CONFIG');
/** A service for dispatching and displaying toast messages. */
export class NxMessageToastService {
    constructor(_overlay, _injector, _live, _parentMessageToastService, _defaultConfig) {
        this._overlay = _overlay;
        this._injector = _injector;
        this._live = _live;
        this._parentMessageToastService = _parentMessageToastService;
        this._defaultConfig = _defaultConfig;
        /**
         * Reference to the current message toast in the view *at this level* (in the Angular injector tree).
         * If there is a parent message toast service, all operations should delegate to that parent
         * via `_oldToastMessageRef`.
         */
        this._toastRefAtThisLevel = null;
    }
    /** Reference to the currently opened message toastat *any* level. */
    get _oldToastMessageRef() {
        const parent = this._parentMessageToastService;
        return parent ? parent._oldToastMessageRef : this._toastRefAtThisLevel;
    }
    set _oldToastMessageRef(value) {
        if (this._parentMessageToastService) {
            this._parentMessageToastService._oldToastMessageRef = value;
        }
        else {
            this._toastRefAtThisLevel = value;
        }
    }
    /** Creates and dispatches a message toastwith a custom text.
     *
     * @param text Text to be used for the message toast.
     * @param config Extra configuration for the message toast.
     */
    open(text, config) {
        const currentConfig = { ...new NxMessageToastConfig(), ...this._defaultConfig, ...config };
        const overlayRef = this._createOverlay(currentConfig);
        const injector = this._createInjector(currentConfig, new NxMessageToastData(text), this._injector);
        const componentPortal = new ComponentPortal(NxMessageToastComponent, undefined, injector);
        const componentRef = overlayRef.attach(componentPortal);
        const toastRef = new NxMessageToastRef(componentRef.instance, overlayRef);
        this._animateToast(toastRef, currentConfig);
        this._oldToastMessageRef = toastRef;
        return this._oldToastMessageRef;
    }
    /** Creates and dispatches a message toastwith a custom template for the content.
     *
     * @param template Template to be used for the message toast.
     * @param config Extra configuration for the message toast.
     */
    openFromTemplate(template, config) {
        const currentConfig = { ...new NxMessageToastConfig(), ...this._defaultConfig, ...config };
        const overlayRef = this._createOverlay(currentConfig);
        const container = this._attachToastComponent(overlayRef, currentConfig);
        const toastRef = new NxMessageToastRef(container, overlayRef);
        const portal = new TemplatePortal(template, null, toastRef);
        container.attachTemplatePortal(portal);
        this._animateToast(toastRef, currentConfig);
        this._oldToastMessageRef = toastRef;
        return this._oldToastMessageRef;
    }
    // Attaches the message toastcontainer component to the overlay.
    _attachToastComponent(overlayRef, config) {
        const injector = this._createInjector(config, null, this._injector);
        const containerPortal = new ComponentPortal(NxMessageToastComponent, null, injector);
        const containerRef = overlayRef.attach(containerPortal);
        containerRef.instance.config = config;
        return containerRef.instance;
    }
    // Creates a new overlay and places it in the correct place.
    _createOverlay(config) {
        const overlayConfig = new OverlayConfig();
        const positionStrategy = this._overlay.position().global();
        positionStrategy.bottom('0');
        positionStrategy.centerHorizontally();
        overlayConfig.positionStrategy = positionStrategy;
        return this._overlay.create(overlayConfig);
    }
    /** Animates the old message toastout and the new one in. */
    _animateToast(toastRef, config) {
        // When the message toastis dismissed, clear the reference to it.
        toastRef.afterDismissed().subscribe(() => {
            // Clear the message toastref if it hasn't already been replaced by a newer message toast.
            if (this._oldToastMessageRef === toastRef) {
                this._oldToastMessageRef = null;
            }
            if (config.announcementMessage) {
                this._live.clear();
            }
        });
        if (this._oldToastMessageRef) {
            // If a message toastis opened, dismiss it and enter the
            // new message toastafter exit animation is complete.
            this._oldToastMessageRef.afterDismissed().subscribe(() => {
                toastRef.toastInstance.enter();
            });
            this._oldToastMessageRef.dismiss();
        }
        else {
            // If no message toastis in view, enter the message toast.
            toastRef.toastInstance.enter();
        }
        // If a message toastduration is provided, set up dismiss based on after the message toastis opened.
        if (config.duration && config.duration > 0) {
            toastRef.afterOpened().subscribe(() => toastRef._dismissAfter(config.duration));
        }
        if (config.announcementMessage) {
            this._live.announce(config.announcementMessage, config.politeness);
        }
    }
    _createInjector(config, data, injector) {
        const tokens = new WeakMap();
        tokens.set(NxMessageToastConfig, config);
        tokens.set(NxMessageToastData, data);
        return new PortalInjector(injector, tokens);
    }
    /**
     * Dismisses the currently visible message toast.
     */
    dismiss() {
        if (this._oldToastMessageRef) {
            this._oldToastMessageRef.dismiss();
        }
    }
    ngOnDestroy() {
        if (this._toastRefAtThisLevel) {
            this._toastRefAtThisLevel.dismiss();
        }
    }
}
NxMessageToastService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxMessageToastService, deps: [{ token: i1.Overlay }, { token: i0.Injector }, { token: i2.LiveAnnouncer }, { token: NxMessageToastService, optional: true, skipSelf: true }, { token: NX_MESSAGE_TOAST_DEFAULT_CONFIG, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
NxMessageToastService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxMessageToastService, providedIn: NxMessageModule });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxMessageToastService, decorators: [{
            type: Injectable,
            args: [{ providedIn: NxMessageModule }]
        }], ctorParameters: function () { return [{ type: i1.Overlay }, { type: i0.Injector }, { type: i2.LiveAnnouncer }, { type: NxMessageToastService, decorators: [{
                    type: Optional
                }, {
                    type: SkipSelf
                }] }, { type: i3.NxMessageToastConfig, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [NX_MESSAGE_TOAST_DEFAULT_CONFIG]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS10b2FzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctYXF1aWxhL3NyYy9tZXNzYWdlL21lc3NhZ2UtdG9hc3QvbWVzc2FnZS10b2FzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBVyxhQUFhLEVBQWMsTUFBTSxzQkFBc0IsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RixPQUFPLEVBQWdCLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUF1QixRQUFRLEVBQUUsUUFBUSxFQUFlLE1BQU0sZUFBZSxDQUFDO0FBRXZJLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNsRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7Ozs7QUFFeEQseUVBQXlFO0FBQ3pFLE1BQU0sQ0FBQyxNQUFNLCtCQUErQixHQUFHLElBQUksY0FBYyxDQUF1QixpQ0FBaUMsQ0FBQyxDQUFDO0FBRTNILCtEQUErRDtBQUUvRCxNQUFNLE9BQU8scUJBQXFCO0lBc0I5QixZQUNZLFFBQWlCLEVBQ2pCLFNBQW1CLEVBQ25CLEtBQW9CLEVBQ0ksMEJBQXdELEVBQzNCLGNBQTJDO1FBSmhHLGFBQVEsR0FBUixRQUFRLENBQVM7UUFDakIsY0FBUyxHQUFULFNBQVMsQ0FBVTtRQUNuQixVQUFLLEdBQUwsS0FBSyxDQUFlO1FBQ0ksK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE4QjtRQUMzQixtQkFBYyxHQUFkLGNBQWMsQ0FBNkI7UUExQjVHOzs7O1dBSUc7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Q0FBQyxvQkFBb0IsRUFBRTtZQUMzQixJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDdkM7SUFDTCxDQUFDOztrSEFsSlEscUJBQXFCLDhGQTBCa0MscUJBQXFCLDZDQUM3RCwrQkFBK0I7c0hBM0I5QyxxQkFBcUIsY0FEUixlQUFlOzJGQUM1QixxQkFBcUI7a0JBRGpDLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFO21JQTJCeUIscUJBQXFCOzBCQUFoRixRQUFROzswQkFBSSxRQUFROzswQkFDcEIsUUFBUTs7MEJBQUksTUFBTTsyQkFBQywrQkFBK0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMaXZlQW5ub3VuY2VyIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2ExMXknO1xuaW1wb3J0IHsgT3ZlcmxheSwgT3ZlcmxheUNvbmZpZywgT3ZlcmxheVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgUG9ydGFsSW5qZWN0b3IsIFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIEluamVjdG9yLCBPbkRlc3Ryb3ksIE9wdGlvbmFsLCBTa2lwU2VsZiwgVGVtcGxhdGVSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgTnhNZXNzYWdlTW9kdWxlIH0gZnJvbSAnLi4vbWVzc2FnZS5tb2R1bGUnO1xuaW1wb3J0IHsgTnhNZXNzYWdlVG9hc3RDb21wb25lbnQgfSBmcm9tICcuL21lc3NhZ2UtdG9hc3QuY29tcG9uZW50JztcbmltcG9ydCB7IE54TWVzc2FnZVRvYXN0Q29uZmlnLCBOeE1lc3NhZ2VUb2FzdERhdGEgfSBmcm9tICcuL21lc3NhZ2UtdG9hc3QtY29uZmlnJztcbmltcG9ydCB7IE54TWVzc2FnZVRvYXN0UmVmIH0gZnJvbSAnLi9tZXNzYWdlLXRvYXN0LXJlZic7XG5cbi8qKiBJbmplY3Rpb24gdG9rZW4gdGhhdCBjYW4gYmUgdXNlZCB0byBzcGVjaWZ5IGRlZmF1bHQgbWVzc2FnZSB0b2FzdC4gKi9cbmV4cG9ydCBjb25zdCBOWF9NRVNTQUdFX1RPQVNUX0RFRkFVTFRfQ09ORklHID0gbmV3IEluamVjdGlvblRva2VuPE54TWVzc2FnZVRvYXN0Q29uZmlnPignTlhfTUVTU0FHRV9UT0FTVF9ERUZBVUxUX0NPTkZJRycpO1xuXG4vKiogQSBzZXJ2aWNlIGZvciBkaXNwYXRjaGluZyBhbmQgZGlzcGxheWluZyB0b2FzdCBtZXNzYWdlcy4gKi9cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogTnhNZXNzYWdlTW9kdWxlIH0pXG5leHBvcnQgY2xhc3MgTnhNZXNzYWdlVG9hc3RTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICAvKipcbiAgICAgKiBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgbWVzc2FnZSB0b2FzdCBpbiB0aGUgdmlldyAqYXQgdGhpcyBsZXZlbCogKGluIHRoZSBBbmd1bGFyIGluamVjdG9yIHRyZWUpLlxuICAgICAqIElmIHRoZXJlIGlzIGEgcGFyZW50IG1lc3NhZ2UgdG9hc3Qgc2VydmljZSwgYWxsIG9wZXJhdGlvbnMgc2hvdWxkIGRlbGVnYXRlIHRvIHRoYXQgcGFyZW50XG4gICAgICogdmlhIGBfb2xkVG9hc3RNZXNzYWdlUmVmYC5cbiAgICAgKi9cbiAgICBwcml2YXRlIF90b2FzdFJlZkF0VGhpc0xldmVsOiBOeE1lc3NhZ2VUb2FzdFJlZiB8IG51bGwgPSBudWxsO1xuXG4gICAgLyoqIFJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IG9wZW5lZCBtZXNzYWdlIHRvYXN0YXQgKmFueSogbGV2ZWwuICovXG4gICAgZ2V0IF9vbGRUb2FzdE1lc3NhZ2VSZWYoKTogTnhNZXNzYWdlVG9hc3RSZWYgfCBudWxsIHtcbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5fcGFyZW50TWVzc2FnZVRvYXN0U2VydmljZTtcbiAgICAgICAgcmV0dXJuIHBhcmVudCA/IHBhcmVudC5fb2xkVG9hc3RNZXNzYWdlUmVmIDogdGhpcy5fdG9hc3RSZWZBdFRoaXNMZXZlbDtcbiAgICB9XG5cbiAgICBzZXQgX29sZFRvYXN0TWVzc2FnZVJlZih2YWx1ZTogTnhNZXNzYWdlVG9hc3RSZWYgfCBudWxsKSB7XG4gICAgICAgIGlmICh0aGlzLl9wYXJlbnRNZXNzYWdlVG9hc3RTZXJ2aWNlKSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJlbnRNZXNzYWdlVG9hc3RTZXJ2aWNlLl9vbGRUb2FzdE1lc3NhZ2VSZWYgPSB2YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3RvYXN0UmVmQXRUaGlzTGV2ZWwgPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIF9vdmVybGF5OiBPdmVybGF5LFxuICAgICAgICBwcml2YXRlIF9pbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIHByaXZhdGUgX2xpdmU6IExpdmVBbm5vdW5jZXIsXG4gICAgICAgIEBPcHRpb25hbCgpIEBTa2lwU2VsZigpIHByaXZhdGUgX3BhcmVudE1lc3NhZ2VUb2FzdFNlcnZpY2U6IE54TWVzc2FnZVRvYXN0U2VydmljZSB8IG51bGwsXG4gICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTlhfTUVTU0FHRV9UT0FTVF9ERUZBVUxUX0NPTkZJRykgcHJpdmF0ZSBfZGVmYXVsdENvbmZpZzogTnhNZXNzYWdlVG9hc3RDb25maWcgfCBudWxsLFxuICAgICkge31cblxuICAgIC8qKiBDcmVhdGVzIGFuZCBkaXNwYXRjaGVzIGEgbWVzc2FnZSB0b2FzdHdpdGggYSBjdXN0b20gdGV4dC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB0ZXh0IFRleHQgdG8gYmUgdXNlZCBmb3IgdGhlIG1lc3NhZ2UgdG9hc3QuXG4gICAgICogQHBhcmFtIGNvbmZpZyBFeHRyYSBjb25maWd1cmF0aW9uIGZvciB0aGUgbWVzc2FnZSB0b2FzdC5cbiAgICAgKi9cbiAgICBvcGVuKHRleHQ6IHN0cmluZywgY29uZmlnPzogTnhNZXNzYWdlVG9hc3RDb25maWcpOiBOeE1lc3NhZ2VUb2FzdFJlZiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb25maWcgPSB7IC4uLm5ldyBOeE1lc3NhZ2VUb2FzdENvbmZpZygpLCAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLCAuLi5jb25maWcgfTtcbiAgICAgICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMuX2NyZWF0ZU92ZXJsYXkoY3VycmVudENvbmZpZyk7XG4gICAgICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IoY3VycmVudENvbmZpZywgbmV3IE54TWVzc2FnZVRvYXN0RGF0YSh0ZXh0KSwgdGhpcy5faW5qZWN0b3IpO1xuXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudFBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoTnhNZXNzYWdlVG9hc3RDb21wb25lbnQsIHVuZGVmaW5lZCwgaW5qZWN0b3IpO1xuICAgICAgICBjb25zdCBjb21wb25lbnRSZWYgPSBvdmVybGF5UmVmLmF0dGFjaChjb21wb25lbnRQb3J0YWwpO1xuICAgICAgICBjb25zdCB0b2FzdFJlZiA9IG5ldyBOeE1lc3NhZ2VUb2FzdFJlZihjb21wb25lbnRSZWYuaW5zdGFuY2UsIG92ZXJsYXlSZWYpO1xuXG4gICAgICAgIHRoaXMuX2FuaW1hdGVUb2FzdCh0b2FzdFJlZiwgY3VycmVudENvbmZpZyk7XG4gICAgICAgIHRoaXMuX29sZFRvYXN0TWVzc2FnZVJlZiA9IHRvYXN0UmVmO1xuICAgICAgICByZXR1cm4gdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmO1xuICAgIH1cblxuICAgIC8qKiBDcmVhdGVzIGFuZCBkaXNwYXRjaGVzIGEgbWVzc2FnZSB0b2FzdHdpdGggYSBjdXN0b20gdGVtcGxhdGUgZm9yIHRoZSBjb250ZW50LlxuICAgICAqXG4gICAgICogQHBhcmFtIHRlbXBsYXRlIFRlbXBsYXRlIHRvIGJlIHVzZWQgZm9yIHRoZSBtZXNzYWdlIHRvYXN0LlxuICAgICAqIEBwYXJhbSBjb25maWcgRXh0cmEgY29uZmlndXJhdGlvbiBmb3IgdGhlIG1lc3NhZ2UgdG9hc3QuXG4gICAgICovXG4gICAgb3BlbkZyb21UZW1wbGF0ZSh0ZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PiwgY29uZmlnPzogTnhNZXNzYWdlVG9hc3RDb25maWcpOiBOeE1lc3NhZ2VUb2FzdFJlZiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb25maWcgPSB7IC4uLm5ldyBOeE1lc3NhZ2VUb2FzdENvbmZpZygpLCAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLCAuLi5jb25maWcgfTtcbiAgICAgICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMuX2NyZWF0ZU92ZXJsYXkoY3VycmVudENvbmZpZyk7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuX2F0dGFjaFRvYXN0Q29tcG9uZW50KG92ZXJsYXlSZWYsIGN1cnJlbnRDb25maWcpO1xuICAgICAgICBjb25zdCB0b2FzdFJlZiA9IG5ldyBOeE1lc3NhZ2VUb2FzdFJlZihjb250YWluZXIsIG92ZXJsYXlSZWYpO1xuICAgICAgICBjb25zdCBwb3J0YWwgPSBuZXcgVGVtcGxhdGVQb3J0YWwodGVtcGxhdGUsIG51bGwhLCB0b2FzdFJlZik7XG5cbiAgICAgICAgY29udGFpbmVyLmF0dGFjaFRlbXBsYXRlUG9ydGFsKHBvcnRhbCk7XG4gICAgICAgIHRoaXMuX2FuaW1hdGVUb2FzdCh0b2FzdFJlZiwgY3VycmVudENvbmZpZyk7XG4gICAgICAgIHRoaXMuX29sZFRvYXN0TWVzc2FnZVJlZiA9IHRvYXN0UmVmO1xuICAgICAgICByZXR1cm4gdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmO1xuICAgIH1cblxuICAgIC8vIEF0dGFjaGVzIHRoZSBtZXNzYWdlIHRvYXN0Y29udGFpbmVyIGNvbXBvbmVudCB0byB0aGUgb3ZlcmxheS5cbiAgICBwcml2YXRlIF9hdHRhY2hUb2FzdENvbXBvbmVudChvdmVybGF5UmVmOiBPdmVybGF5UmVmLCBjb25maWc6IE54TWVzc2FnZVRvYXN0Q29uZmlnKTogTnhNZXNzYWdlVG9hc3RDb21wb25lbnQge1xuICAgICAgICBjb25zdCBpbmplY3RvciA9IHRoaXMuX2NyZWF0ZUluamVjdG9yKGNvbmZpZywgbnVsbCwgdGhpcy5faW5qZWN0b3IpO1xuICAgICAgICBjb25zdCBjb250YWluZXJQb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKE54TWVzc2FnZVRvYXN0Q29tcG9uZW50LCBudWxsLCBpbmplY3Rvcik7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lclJlZjogQ29tcG9uZW50UmVmPE54TWVzc2FnZVRvYXN0Q29tcG9uZW50PiA9IG92ZXJsYXlSZWYuYXR0YWNoKGNvbnRhaW5lclBvcnRhbCk7XG4gICAgICAgIGNvbnRhaW5lclJlZi5pbnN0YW5jZS5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclJlZi5pbnN0YW5jZTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGVzIGEgbmV3IG92ZXJsYXkgYW5kIHBsYWNlcyBpdCBpbiB0aGUgY29ycmVjdCBwbGFjZS5cbiAgICBwcml2YXRlIF9jcmVhdGVPdmVybGF5KGNvbmZpZzogTnhNZXNzYWdlVG9hc3RDb25maWcpOiBPdmVybGF5UmVmIHtcbiAgICAgICAgY29uc3Qgb3ZlcmxheUNvbmZpZyA9IG5ldyBPdmVybGF5Q29uZmlnKCk7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLl9vdmVybGF5LnBvc2l0aW9uKCkuZ2xvYmFsKCk7XG5cbiAgICAgICAgcG9zaXRpb25TdHJhdGVneS5ib3R0b20oJzAnKTtcbiAgICAgICAgcG9zaXRpb25TdHJhdGVneS5jZW50ZXJIb3Jpem9udGFsbHkoKTtcbiAgICAgICAgb3ZlcmxheUNvbmZpZy5wb3NpdGlvblN0cmF0ZWd5ID0gcG9zaXRpb25TdHJhdGVneTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fb3ZlcmxheS5jcmVhdGUob3ZlcmxheUNvbmZpZyk7XG4gICAgfVxuXG4gICAgLyoqIEFuaW1hdGVzIHRoZSBvbGQgbWVzc2FnZSB0b2FzdG91dCBhbmQgdGhlIG5ldyBvbmUgaW4uICovXG4gICAgcHJpdmF0ZSBfYW5pbWF0ZVRvYXN0KHRvYXN0UmVmOiBOeE1lc3NhZ2VUb2FzdFJlZiwgY29uZmlnOiBOeE1lc3NhZ2VUb2FzdENvbmZpZykge1xuICAgICAgICAvLyBXaGVuIHRoZSBtZXNzYWdlIHRvYXN0aXMgZGlzbWlzc2VkLCBjbGVhciB0aGUgcmVmZXJlbmNlIHRvIGl0LlxuICAgICAgICB0b2FzdFJlZi5hZnRlckRpc21pc3NlZCgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAvLyBDbGVhciB0aGUgbWVzc2FnZSB0b2FzdHJlZiBpZiBpdCBoYXNuJ3QgYWxyZWFkeSBiZWVuIHJlcGxhY2VkIGJ5IGEgbmV3ZXIgbWVzc2FnZSB0b2FzdC5cbiAgICAgICAgICAgIGlmICh0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYgPT09IHRvYXN0UmVmKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmID0gbnVsbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fbGl2ZS5jbGVhcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmKSB7XG4gICAgICAgICAgICAvLyBJZiBhIG1lc3NhZ2UgdG9hc3RpcyBvcGVuZWQsIGRpc21pc3MgaXQgYW5kIGVudGVyIHRoZVxuICAgICAgICAgICAgLy8gbmV3IG1lc3NhZ2UgdG9hc3RhZnRlciBleGl0IGFuaW1hdGlvbiBpcyBjb21wbGV0ZS5cbiAgICAgICAgICAgIHRoaXMuX29sZFRvYXN0TWVzc2FnZVJlZi5hZnRlckRpc21pc3NlZCgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdG9hc3RSZWYudG9hc3RJbnN0YW5jZS5lbnRlcigpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYuZGlzbWlzcygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gSWYgbm8gbWVzc2FnZSB0b2FzdGlzIGluIHZpZXcsIGVudGVyIHRoZSBtZXNzYWdlIHRvYXN0LlxuICAgICAgICAgICAgdG9hc3RSZWYudG9hc3RJbnN0YW5jZS5lbnRlcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gSWYgYSBtZXNzYWdlIHRvYXN0ZHVyYXRpb24gaXMgcHJvdmlkZWQsIHNldCB1cCBkaXNtaXNzIGJhc2VkIG9uIGFmdGVyIHRoZSBtZXNzYWdlIHRvYXN0aXMgb3BlbmVkLlxuICAgICAgICBpZiAoY29uZmlnLmR1cmF0aW9uICYmIGNvbmZpZy5kdXJhdGlvbiA+IDApIHtcbiAgICAgICAgICAgIHRvYXN0UmVmLmFmdGVyT3BlbmVkKCkuc3Vic2NyaWJlKCgpID0+IHRvYXN0UmVmLl9kaXNtaXNzQWZ0ZXIoY29uZmlnLmR1cmF0aW9uISkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlKSB7XG4gICAgICAgICAgICB0aGlzLl9saXZlLmFubm91bmNlKGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlLCBjb25maWcucG9saXRlbmVzcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9jcmVhdGVJbmplY3Rvcihjb25maWc6IE54TWVzc2FnZVRvYXN0Q29uZmlnLCBkYXRhOiBOeE1lc3NhZ2VUb2FzdERhdGEgfCBudWxsLCBpbmplY3RvcjogSW5qZWN0b3IpOiBQb3J0YWxJbmplY3RvciB7XG4gICAgICAgIGNvbnN0IHRva2VucyA9IG5ldyBXZWFrTWFwKCk7XG4gICAgICAgIHRva2Vucy5zZXQoTnhNZXNzYWdlVG9hc3RDb25maWcsIGNvbmZpZyk7XG4gICAgICAgIHRva2Vucy5zZXQoTnhNZXNzYWdlVG9hc3REYXRhLCBkYXRhKTtcblxuICAgICAgICByZXR1cm4gbmV3IFBvcnRhbEluamVjdG9yKGluamVjdG9yLCB0b2tlbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIERpc21pc3NlcyB0aGUgY3VycmVudGx5IHZpc2libGUgbWVzc2FnZSB0b2FzdC5cbiAgICAgKi9cbiAgICBkaXNtaXNzKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmKSB7XG4gICAgICAgICAgICB0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYuZGlzbWlzcygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIGlmICh0aGlzLl90b2FzdFJlZkF0VGhpc0xldmVsKSB7XG4gICAgICAgICAgICB0aGlzLl90b2FzdFJlZkF0VGhpc0xldmVsLmRpc21pc3MoKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==