import { Directive, forwardRef, Inject } from '@angular/core';
import { NG_VALIDATORS } from '@angular/forms';
import * as IBAN from 'iban';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { NxMaskDirective } from './mask.directive';
import * as i0 from "@angular/core";
import * as i1 from "./mask.directive";
export const NX_IBAN_MASK_VALIDATORS = {
    provide: NG_VALIDATORS,
    useExisting: forwardRef(() => NxIbanMaskDirective),
    multi: true,
};
/**
 * To use the `NxIbanMaskDirective`, you have to install the **peer dependency** `iban.js`.
 */
export class NxIbanMaskDirective {
    constructor(_elementRef, maskDirective) {
        this._elementRef = _elementRef;
        this.maskDirective = maskDirective;
        this._destroyed = new Subject();
        this._afterInputHook = (event) => {
            const input = event.target;
            this._setCountryCode(input.value.substr(0, 2));
        };
        this._beforePasteHook = (event) => {
            // change the country code here if necessary
            const input = event.target;
            const pastedData = (event.clipboardData || window.clipboardData).getData('text');
            const enteredCountryCode = (this.maskDirective.elementRefValue.substr(0, input.selectionStart) +
                this.maskDirective.getMaskedString(pastedData, input.selectionStart)).substr(0, 2);
            this._setCountryCode(enteredCountryCode);
        };
        this.maskDirective.registerAfterInputHook(this._afterInputHook);
        this.maskDirective.registerBeforePasteHook(this._beforePasteHook);
        this.maskDirective.cvaModelChange.pipe(takeUntil(this._destroyed)).subscribe((value) => {
            const enteredCountryCode = this.maskDirective.getMaskedString(value).substr(0, 2);
            this._setCountryCode(enteredCountryCode);
        });
    }
    _setCountryCode(code) {
        code = code.toUpperCase();
        if (code.length === 2 && this._countryCode !== code) {
            if (IBAN.countries[code]) {
                this._countryCode = code;
                this.maskDirective.setMask(this._getMask(this._countryCode));
            }
            else {
                this._countryCode = null;
                this.maskDirective.setMask('SS');
            }
        }
    }
    ngOnInit() {
        // set only first two letters as I don't know a country yet
        this.maskDirective.mask = 'SS';
        this.maskDirective.convertTo = 'upper';
    }
    ngOnDestroy() {
        this._destroyed.next();
        this._destroyed.complete();
    }
    _getMask(countryCode) {
        // the countrySpecs of a country contain: countryCode ("DE"), length (22), structure ("F08F10")
        // and an example belonging to each country
        const countrySpecs = IBAN.countries[countryCode];
        // 'SS' for country code + '00' for IBAN checksum
        let mask = 'SS00';
        // split up after every third character
        const characterDefs = countrySpecs.structure.match(/.{1,3}/g);
        characterDefs.forEach((charDef) => {
            const character = charDef[0];
            const count = Number(charDef.substring(1, 3));
            switch (character) {
                // [0-9]
                case 'F':
                    mask += '0'.repeat(count);
                    break;
                // [0-9A-Za-z]
                case 'A':
                    mask += 'A'.repeat(count);
                    break;
                // [A-Z]
                // 'S' in nxMask does accept also [a-z].
                // There is no option for only accepting capital letters at the moment.
                case 'U':
                    mask += 'S'.repeat(count);
                    break;
            }
        });
        // insert whitespaces after every 4 characters
        mask = mask.match(/.{1,4}/g).join(' ');
        return mask;
    }
    _validateFn() {
        if (this._countryCodeValid()) {
            return { nxIbanInvalidCountryError: 'no valid country code' };
        }
        if (!IBAN.isValid(this.maskDirective.getUnmaskedValue())) {
            return { nxIbanParseError: 'no valid iban' };
        }
        return null;
    }
    /** @docs-private */
    validate() {
        return this.maskDirective.validateMask ? this._validateFn() : null;
    }
    _touch() {
        this.maskDirective._touch();
    }
    _countryCodeValid() {
        const enteredCountryCode = this._elementRef.nativeElement.value.substr(0, 2);
        return enteredCountryCode.length === 2 && !IBAN.countries[enteredCountryCode];
    }
}
NxIbanMaskDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxIbanMaskDirective, deps: [{ token: i0.ElementRef }, { token: forwardRef(() => NxMaskDirective) }], target: i0.ɵɵFactoryTarget.Directive });
NxIbanMaskDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.3.1", type: NxIbanMaskDirective, selector: "input[nxIbanMask]", host: { listeners: { "input": "_countryCodeValid() && _touch()" } }, providers: [NX_IBAN_MASK_VALIDATORS], exportAs: ["nxIbanMaskDirective"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxIbanMaskDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'input[nxIbanMask]',
                    exportAs: 'nxIbanMaskDirective',
                    providers: [NX_IBAN_MASK_VALIDATORS],
                    host: {
                        '(input)': '_countryCodeValid() && _touch()',
                    },
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.NxMaskDirective, decorators: [{
                    type: Inject,
                    args: [forwardRef(() => NxMaskDirective)]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWJhbi1tYXNrLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWFxdWlsYS9zcmMvbWFzay9pYmFuLW1hc2suZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQWMsVUFBVSxFQUFFLE1BQU0sRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDN0YsT0FBTyxFQUFFLGFBQWEsRUFBYSxNQUFNLGdCQUFnQixDQUFDO0FBQzFELE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7O0FBRW5ELE1BQU0sQ0FBQyxNQUFNLHVCQUF1QixHQUFRO0lBQ3hDLE9BQU8sRUFBRSxhQUFhO0lBQ3RCLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsbUJBQW1CLENBQUM7SUFDbEQsS0FBSyxFQUFFLElBQUk7Q0FDZCxDQUFDO0FBRUY7O0dBRUc7QUFTSCxNQUFNLE9BQU8sbUJBQW1CO0lBSzVCLFlBQW9CLFdBQXVCLEVBQXFELGFBQThCO1FBQTFHLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQXFELGtCQUFhLEdBQWIsYUFBYSxDQUFpQjtRQUY3RyxlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQVkxQyxvQkFBZSxHQUFHLENBQUMsS0FBb0IsRUFBRSxFQUFFO1lBQy9DLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUEwQixDQUFDO1lBQy9DLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkQsQ0FBQyxD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QUFhLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN2RSxDQUFDO0lBRUQsTUFBTTtRQUNGLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEMsQ0FBQztJQUVPLGlCQUFpQjtRQUNyQixNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTdFLE9BQU8sa0JBQWtCLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNsRixDQUFDOztnSEF2SFEsbUJBQW1CLDRDQUt5QixVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDO29HQUw3RSxtQkFBbUIsaUhBTGpCLENBQUMsdUJBQXVCLENBQUM7MkZBSzNCLG1CQUFtQjtrQkFSL0IsU0FBUzttQkFBQztvQkFDUCxRQUFRLEVBQUUsbUJBQW1CO29CQUM3QixRQUFRLEVBQUUscUJBQXFCO29CQUMvQixTQUFTLEVBQUUsQ0FBQyx1QkFBdUIsQ0FBQztvQkFDcEMsSUFBSSxFQUFFO3dCQUNGLFNBQVMsRUFBRSxpQ0FBaUM7cUJBQy9DO2lCQUNKOzswQkFNaUQsTUFBTTsyQkFBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBmb3J3YXJkUmVmLCBJbmplY3QsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOR19WQUxJREFUT1JTLCBWYWxpZGF0b3IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgKiBhcyBJQkFOIGZyb20gJ2liYW4nO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBOeE1hc2tEaXJlY3RpdmUgfSBmcm9tICcuL21hc2suZGlyZWN0aXZlJztcblxuZXhwb3J0IGNvbnN0IE5YX0lCQU5fTUFTS19WQUxJREFUT1JTOiBhbnkgPSB7XG4gICAgcHJvdmlkZTogTkdfVkFMSURBVE9SUyxcbiAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBOeEliYW5NYXNrRGlyZWN0aXZlKSxcbiAgICBtdWx0aTogdHJ1ZSxcbn07XG5cbi8qKlxuICogVG8gdXNlIHRoZSBgTnhJYmFuTWFza0RpcmVjdGl2ZWAsIHlvdSBoYXZlIHRvIGluc3RhbGwgdGhlICoqcGVlciBkZXBlbmRlbmN5KiogYGliYW4uanNgLlxuICovXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ2lucHV0W254SWJhbk1hc2tdJyxcbiAgICBleHBvcnRBczogJ254SWJhbk1hc2tEaXJlY3RpdmUnLFxuICAgIHByb3ZpZGVyczogW05YX0lCQU5fTUFTS19WQUxJREFUT1JTXSxcbiAgICBob3N0OiB7XG4gICAgICAgICcoaW5wdXQpJzogJ19jb3VudHJ5Q29kZVZhbGlkKCkgJiYgX3RvdWNoKCknLFxuICAgIH0sXG59KVxuZXhwb3J0IGNsYXNzIE54SWJhbk1hc2tEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgVmFsaWRhdG9yIHtcbiAgICBwcml2YXRlIF9jb3VudHJ5Q29kZSE6IHN0cmluZyB8IG51bGw7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9kZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfZWxlbWVudFJlZjogRWxlbWVudFJlZiwgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IE54TWFza0RpcmVjdGl2ZSkpIHByaXZhdGUgbWFza0RpcmVjdGl2ZTogTnhNYXNrRGlyZWN0aXZlKSB7XG4gICAgICAgIHRoaXMubWFza0RpcmVjdGl2ZS5yZWdpc3RlckFmdGVySW5wdXRIb29rKHRoaXMuX2FmdGVySW5wdXRIb29rKTtcbiAgICAgICAgdGhpcy5tYXNrRGlyZWN0aXZlLnJlZ2lzdGVyQmVmb3JlUGFzdGVIb29rKHRoaXMuX2JlZm9yZVBhc3RlSG9vayk7XG5cbiAgICAgICAgdGhpcy5tYXNrRGlyZWN0aXZlLmN2YU1vZGVsQ2hhbmdlLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCkpLnN1YnNjcmliZSgodmFsdWU6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgZW50ZXJlZENvdW50cnlDb2RlID0gdGhpcy5tYXNrRGlyZWN0aXZlLmdldE1hc2tlZFN0cmluZyh2YWx1ZSkuc3Vic3RyKDAsIDIpO1xuICAgICAgICAgICAgdGhpcy5fc2V0Q291bnRyeUNvZGUoZW50ZXJlZENvdW50cnlDb2RlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYWZ0ZXJJbnB1dEhvb2sgPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgaW5wdXQgPSBldmVudC50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudDtcbiAgICAgICAgdGhpcy5fc2V0Q291bnRyeUNvZGUoaW5wdXQudmFsdWUuc3Vic3RyKDAsIDIpKTtcbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBfYmVmb3JlUGFzdGVIb29rID0gKGV2ZW50OiBDbGlwYm9hcmRFdmVudCkgPT4ge1xuICAgICAgICAvLyBjaGFuZ2UgdGhlIGNvdW50cnkgY29kZSBoZXJlIGlmIG5lY2Vzc2FyeVxuICAgICAgICBjb25zdCBpbnB1dDogSFRNTElucHV0RWxlbWVudCA9IGV2ZW50LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgICAgICBjb25zdCBwYXN0ZWREYXRhID0gKGV2ZW50LmNsaXBib2FyZERhdGEgfHwgKHdpbmRvdyBhcyBhbnkpLmNsaXBib2FyZERhdGEpLmdldERhdGEoJ3RleHQnKTtcblxuICAgICAgICBjb25zdCBlbnRlcmVkQ291bnRyeUNvZGUgPSAoXG4gICAgICAgICAgICB0aGlzLm1hc2tEaXJlY3RpdmUuZWxlbWVudFJlZlZhbHVlLnN1YnN0cigwLCBpbnB1dC5zZWxlY3Rpb25TdGFydCBhcyBudW1iZXIpICtcbiAgICAgICAgICAgIHRoaXMubWFza0RpcmVjdGl2ZS5nZXRNYXNrZWRTdHJpbmcocGFzdGVkRGF0YSwgaW5wdXQuc2VsZWN0aW9uU3RhcnQgYXMgbnVtYmVyKVxuICAgICAgICApLnN1YnN0cigwLCAyKTtcblxuICAgICAgICB0aGlzLl9zZXRDb3VudHJ5Q29kZShlbnRlcmVkQ291bnRyeUNvZGUpO1xuICAgIH07XG5cbiAgICBwcml2YXRlIF9zZXRDb3VudHJ5Q29kZShjb2RlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29kZSA9IGNvZGUudG9VcHBlckNhc2UoKTtcbiAgICAgICAgaWYgKGNvZGUubGVuZ3RoID09PSAyICYmIHRoaXMuX2NvdW50cnlDb2RlICE9PSBjb2RlKSB7XG4gICAgICAgICAgICBpZiAoSUJBTi5jb3VudHJpZXNbY29kZV0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jb3VudHJ5Q29kZSA9IGNvZGU7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXNrRGlyZWN0aXZlLnNldE1hc2sodGhpcy5fZ2V0TWFzayh0aGlzLl9jb3VudHJ5Q29kZSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9jb3VudHJ5Q29kZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXNrRGlyZWN0aXZlLnNldE1hc2soJ1NTJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAgICAgLy8gc2V0IG9ubHkgZmlyc3QgdHdvIGxldHRlcnMgYXMgSSBkb24ndCBrbm93IGEgY291bnRyeSB5ZXRcbiAgICAgICAgdGhpcy5tYXNrRGlyZWN0aXZlLm1hc2sgPSAnU1MnO1xuICAgICAgICB0aGlzLm1hc2tEaXJlY3RpdmUuY29udmVydFRvID0gJ3VwcGVyJztcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fZGVzdHJveWVkLm5leHQoKTtcbiAgICAgICAgdGhpcy5fZGVzdHJveWVkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0TWFzayhjb3VudHJ5Q29kZTogc3RyaW5nKSB7XG4gICAgICAgIC8vIHRoZSBjb3VudHJ5U3BlY3Mgb2YgYSBjb3VudHJ5IGNvbnRhaW46IGNvdW50cnlDb2RlIChcIkRFXCIpLCBsZW5ndGggKDIyKSwgc3RydWN0dXJlIChcIkYwOEYxMFwiKVxuICAgICAgICAvLyBhbmQgYW4gZXhhbXBsZSBiZWxvbmdpbmcgdG8gZWFjaCBjb3VudHJ5XG4gICAgICAgIGNvbnN0IGNvdW50cnlTcGVjcyA9IElCQU4uY291bnRyaWVzW2NvdW50cnlDb2RlXTtcblxuICAgICAgICAvLyAnU1MnIGZvciBjb3VudHJ5IGNvZGUgKyAnMDAnIGZvciBJQkFOIGNoZWNrc3VtXG4gICAgICAgIGxldCBtYXNrID0gJ1NTMDAnO1xuXG4gICAgICAgIC8vIHNwbGl0IHVwIGFmdGVyIGV2ZXJ5IHRoaXJkIGNoYXJhY3RlclxuICAgICAgICBjb25zdCBjaGFyYWN0ZXJEZWZzID0gY291bnRyeVNwZWNzLnN0cnVjdHVyZS5tYXRjaCgvLnsxLDN9L2cpO1xuXG4gICAgICAgIGNoYXJhY3RlckRlZnMhLmZvckVhY2goKGNoYXJEZWY6IGFueSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hhcmFjdGVyID0gY2hhckRlZlswXTtcbiAgICAgICAgICAgIGNvbnN0IGNvdW50ID0gTnVtYmVyKGNoYXJEZWYuc3Vic3RyaW5nKDEsIDMpKTtcblxuICAgICAgICAgICAgc3dpdGNoIChjaGFyYWN0ZXIpIHtcbiAgICAgICAgICAgICAgICAvLyBbMC05XVxuICAgICAgICAgICAgICAgIGNhc2UgJ0YnOlxuICAgICAgICAgICAgICAgICAgICBtYXNrICs9ICcwJy5yZXBlYXQoY291bnQpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAvLyBbMC05QS1aYS16XVxuICAgICAgICAgICAgICAgIGNhc2UgJ0EnOlxuICAgICAgICAgICAgICAgICAgICBtYXNrICs9ICdBJy5yZXBlYXQoY291bnQpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAvLyBbQS1aXVxuICAgICAgICAgICAgICAgIC8vICdTJyBpbiBueE1hc2sgZG9lcyBhY2NlcHQgYWxzbyBbYS16XS5cbiAgICAgICAgICAgICAgICAvLyBUaGVyZSBpcyBubyBvcHRpb24gZm9yIG9ubHkgYWNjZXB0aW5nIGNhcGl0YWwgbGV0dGVycyBhdCB0aGUgbW9tZW50LlxuICAgICAgICAgICAgICAgIGNhc2UgJ1UnOlxuICAgICAgICAgICAgICAgICAgICBtYXNrICs9ICdTJy5yZXBlYXQoY291bnQpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gaW5zZXJ0IHdoaXRlc3BhY2VzIGFmdGVyIGV2ZXJ5IDQgY2hhcmFjdGVyc1xuICAgICAgICBtYXNrID0gbWFzay5tYXRjaCgvLnsxLDR9L2cpIS5qb2luKCcgJyk7XG5cbiAgICAgICAgcmV0dXJuIG1hc2s7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdmFsaWRhdGVGbigpIHtcbiAgICAgICAgaWYgKHRoaXMuX2NvdW50cnlDb2RlVmFsaWQoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgbnhJYmFuSW52YWxpZENvdW50cnlFcnJvcjogJ25vIHZhbGlkIGNvdW50cnkgY29kZScgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIUlCQU4uaXNWYWxpZCh0aGlzLm1hc2tEaXJlY3RpdmUuZ2V0VW5tYXNrZWRWYWx1ZSgpKSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgbnhJYmFuUGFyc2VFcnJvcjogJ25vIHZhbGlkIGliYW4nIH07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLyoqIEBkb2NzLXByaXZhdGUgKi9cbiAgICB2YWxpZGF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWFza0RpcmVjdGl2ZS52YWxpZGF0ZU1hc2sgPyB0aGlzLl92YWxpZGF0ZUZuKCkgOiBudWxsO1xuICAgIH1cblxuICAgIF90b3VjaCgpIHtcbiAgICAgICAgdGhpcy5tYXNrRGlyZWN0aXZlLl90b3VjaCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NvdW50cnlDb2RlVmFsaWQoKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGVudGVyZWRDb3VudHJ5Q29kZSA9IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC52YWx1ZS5zdWJzdHIoMCwgMik7XG5cbiAgICAgICAgcmV0dXJuIGVudGVyZWRDb3VudHJ5Q29kZS5sZW5ndGggPT09IDIgJiYgIUlCQU4uY291bnRyaWVzW2VudGVyZWRDb3VudHJ5Q29kZV07XG4gICAgfVxufVxuIl19