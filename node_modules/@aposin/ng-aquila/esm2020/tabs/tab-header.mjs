import { FocusKeyManager } from '@angular/cdk/a11y';
import { END, ENTER, HOME, SPACE } from '@angular/cdk/keycodes';
import { ChangeDetectionStrategy, Component, ContentChildren, EventEmitter, Input, Optional, Output, ViewChild, } from '@angular/core';
import { NxScrollableTabBar } from './scrollable-tab-bar';
import { NxTabLabelWrapperDirective } from './tab-label-wrapper';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/bidi";
import * as i2 from "./tab-group-base";
import * as i3 from "./scroll-indicator/scroll-indicator";
import * as i4 from "@angular/common";
/** @docs-private */
export class NxTabHeaderComponent extends NxScrollableTabBar {
    constructor(_cdr, _dir, _tabGroup, _element) {
        super(_cdr, _dir, _element);
        this._cdr = _cdr;
        this._tabGroup = _tabGroup;
        this._selectedIndex = 0;
        this._autoselect = true;
        this.selectFocusedIndex = new EventEmitter();
        this.indexFocused = new EventEmitter();
    }
    get selectedIndex() {
        return this._selectedIndex;
    }
    set selectedIndex(value) {
        this._selectedIndex = value;
        if (this._keyManager) {
            this._keyManager.updateActiveItem(value);
        }
    }
    get focusIndex() {
        return this._keyManager ? this._keyManager.activeItemIndex : 0;
    }
    set focusIndex(value) {
        if (!this._isValidIndex(value) || this.focusIndex === value || !this._keyManager) {
            return;
        }
        this._keyManager.setActiveItem(value);
    }
    get autoselect() {
        return this._autoselect;
    }
    set autoselect(value) {
        this._autoselect = value;
    }
    ngAfterContentInit() {
        super.ngAfterContentInit();
        this._keyManager = new FocusKeyManager(this.labels).withHorizontalOrientation('ltr').withWrap();
        this._keyManager.updateActiveItem(0);
        this._cdr.markForCheck();
    }
    _isValidIndex(idx) {
        if (!this.labels) {
            return true;
        }
        const tab = this.labels.toArray()[idx] || null;
        return !!tab && !tab.disabled;
    }
    /**
     * Handles keyboard inputs on the labels
     * If autoselect is enabled the tab gets changed immediately
     * If autoselect is disabled only the focus changes but the user still has to select the item
     * by himself
     */
    handleKeydown(event) {
        switch (event.keyCode) {
            case HOME:
                this._keyManager.setFirstItemActive();
                event.preventDefault();
                break;
            case END:
                this._keyManager.setLastItemActive();
                event.preventDefault();
                break;
            case ENTER:
            case SPACE:
                this.selectFocusedIndex.emit(this._keyManager.activeItemIndex);
                event.preventDefault();
                break;
            default:
                this._keyManager.onKeydown(event);
        }
        if (this.autoselect) {
            this.selectFocusedIndex.emit(this._keyManager.activeItemIndex);
        }
        else if (event.keyCode !== ENTER && event.keyCode !== SPACE) {
            this.indexFocused.emit(this._keyManager.activeItemIndex);
        }
    }
}
NxTabHeaderComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxTabHeaderComponent, deps: [{ token: i0.ChangeDetectorRef }, { token: i1.Directionality, optional: true }, { token: i2.NxTabGroupBase, optional: true }, { token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Component });
NxTabHeaderComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.1", type: NxTabHeaderComponent, selector: "nx-tab-header", inputs: { selectedIndex: "selectedIndex", autoselect: "autoselect" }, outputs: { selectFocusedIndex: "selectFocusedIndex", indexFocused: "indexFocused" }, host: { properties: { "class.at-start": "_isScrolledToStart", "class.scrollable": "scrollable" } }, queries: [{ propertyName: "tabButtons", predicate: ["tabButton"] }, { propertyName: "labels", predicate: NxTabLabelWrapperDirective }], viewQueries: [{ propertyName: "scrollableTabsList", first: true, predicate: ["tabsList"], descendants: true }], usesInheritance: true, ngImport: i0, template: "<nx-tab-scroll-indicator *ngIf=\"scrollable\" scrollDirection=\"start\" [isScrolledToStart]=\"_isScrolledToStart\" (buttonClicked)=\"scrollToStart()\">\n</nx-tab-scroll-indicator>\n<div #tabsList class=\"nx-tab-header\" (keydown)=\"handleKeydown($event)\" role=\"tablist\" tabindex=\"-1\">\n    <ng-content></ng-content>\n</div>\n<nx-tab-scroll-indicator *ngIf=\"scrollable\" scrollDirection=\"end\" [isScrolledToEnd]=\"_isScrolledToEnd\" (buttonClicked)=\"scrollToEnd()\">\n</nx-tab-scroll-indicator>\n", styles: [":host{display:flex;justify-content:center}:host .nx-tab-header{display:flex;align-items:flex-end;overflow-x:scroll;position:relative;outline:none;-ms-overflow-style:none;scrollbar-width:none}:host .nx-tab-header::-webkit-scrollbar{display:none}:host.at-start .nx-tab-header{margin-left:-8px;padding-left:8px}[dir=rtl] :host.at-start .nx-tab-header{margin-left:0;padding-left:0;margin-right:-8px;padding-right:8px}:host:not(.scrollable) .nx-tab-header{margin-right:-8px;padding-right:8px}[dir=rtl] :host:not(.scrollable) .nx-tab-header{margin-right:0;padding-right:0;margin-left:-8px;padding-left:8px}:host-context(nx-tab-group.is-expert){justify-content:flex-start;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:var(--tab-expert-bottom-border-color)}:host-context(nx-tab-group.is-expert) .nx-tab-header{width:100%}\n"], components: [{ type: i3.NxTabScrollIndicator, selector: "nx-tab-scroll-indicator", inputs: ["scrollDirection", "isScrolledToStart", "isScrolledToEnd"], outputs: ["buttonClicked"] }], directives: [{ type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxTabHeaderComponent, decorators: [{
            type: Component,
            args: [{ selector: 'nx-tab-header', changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        '[class.at-start]': '_isScrolledToStart',
                        '[class.scrollable]': 'scrollable',
                    }, template: "<nx-tab-scroll-indicator *ngIf=\"scrollable\" scrollDirection=\"start\" [isScrolledToStart]=\"_isScrolledToStart\" (buttonClicked)=\"scrollToStart()\">\n</nx-tab-scroll-indicator>\n<div #tabsList class=\"nx-tab-header\" (keydown)=\"handleKeydown($event)\" role=\"tablist\" tabindex=\"-1\">\n    <ng-content></ng-content>\n</div>\n<nx-tab-scroll-indicator *ngIf=\"scrollable\" scrollDirection=\"end\" [isScrolledToEnd]=\"_isScrolledToEnd\" (buttonClicked)=\"scrollToEnd()\">\n</nx-tab-scroll-indicator>\n", styles: [":host{display:flex;justify-content:center}:host .nx-tab-header{display:flex;align-items:flex-end;overflow-x:scroll;position:relative;outline:none;-ms-overflow-style:none;scrollbar-width:none}:host .nx-tab-header::-webkit-scrollbar{display:none}:host.at-start .nx-tab-header{margin-left:-8px;padding-left:8px}[dir=rtl] :host.at-start .nx-tab-header{margin-left:0;padding-left:0;margin-right:-8px;padding-right:8px}:host:not(.scrollable) .nx-tab-header{margin-right:-8px;padding-right:8px}[dir=rtl] :host:not(.scrollable) .nx-tab-header{margin-right:0;padding-right:0;margin-left:-8px;padding-left:8px}:host-context(nx-tab-group.is-expert){justify-content:flex-start;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:var(--tab-expert-bottom-border-color)}:host-context(nx-tab-group.is-expert) .nx-tab-header{width:100%}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }, { type: i1.Directionality, decorators: [{
                    type: Optional
                }] }, { type: i2.NxTabGroupBase, decorators: [{
                    type: Optional
                }] }, { type: i0.ElementRef }]; }, propDecorators: { scrollableTabsList: [{
                type: ViewChild,
                args: ['tabsList']
            }], tabButtons: [{
                type: ContentChildren,
                args: ['tabButton']
            }], selectedIndex: [{
                type: Input
            }], autoselect: [{
                type: Input
            }], selectFocusedIndex: [{
                type: Output
            }], indexFocused: [{
                type: Output
            }], labels: [{
                type: ContentChildren,
                args: [NxTabLabelWrapperDirective]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFiLWhlYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWFxdWlsYS9zcmMvdGFicy90YWItaGVhZGVyLnRzIiwiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctYXF1aWxhL3NyYy90YWJzL3RhYi1oZWFkZXIuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2hFLE9BQU8sRUFFSCx1QkFBdUIsRUFFdkIsU0FBUyxFQUNULGVBQWUsRUFFZixZQUFZLEVBQ1osS0FBSyxFQUNMLFFBQVEsRUFDUixNQUFNLEVBRU4sU0FBUyxHQUNaLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7Ozs7QUFFakUsb0JBQW9CO0FBV3BCLE1BQU0sT0FBTyxvQkFBcUIsU0FBUSxrQkFBa0I7SUE0Q3hELFlBQ1csSUFBdUIsRUFDbEIsSUFBMkIsRUFDcEIsU0FBZ0MsRUFDbkQsUUFBb0I7UUFFcEIsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFMckIsU0FBSSxHQUFKLElBQUksQ0FBbUI7UUFFWCxjQUFTLEdBQVQsU0FBUyxDQUF1QjtRQXpDL0MsbUJBQWMsR0FBRyxDQUFDLENBQUM7UUF1Qm5CLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBVVIsdUJBQWtCLEdBQXlCLElBQUksWUFBWSxFQUFVLENBQUM7UUFDdEUsaUJBQVksR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztJQVduRixDQUFDO0lBM0NELElBQ0ksYUFBYTtRQUNiLE9BQU8s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QzNELElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBeUIsQ0FBQyxDQUFDO1NBQ3RFO0lBQ0wsQ0FBQzs7aUhBakdRLG9CQUFvQjtxR0FBcEIsb0JBQW9CLHFZQTBDWiwwQkFBMEIsb0tDM0UvQyx5ZkFPQTsyRkQwQmEsb0JBQW9CO2tCQVZoQyxTQUFTOytCQUNJLGVBQWUsbUJBR1IsdUJBQXVCLENBQUMsTUFBTSxRQUN6Qzt3QkFDRixrQkFBa0IsRUFBRSxvQkFBb0I7d0JBQ3hDLG9CQUFvQixFQUFFLFlBQVk7cUJBQ3JDOzswQkFnREksUUFBUTs7MEJBQ1IsUUFBUTtxRUE1Q1Usa0JBQWtCO3NCQUF4QyxTQUFTO3VCQUFDLFVBQVU7Z0JBQ1MsVUFBVTtzQkFBdkMsZUFBZTt1QkFBQyxXQUFXO2dCQUt4QixhQUFhO3NCQURoQixLQUFLO2dCQXdCRixVQUFVO3NCQURiLEtBQUs7Z0JBUWEsa0JBQWtCO3NCQUFwQyxNQUFNO2dCQUNZLFlBQVk7c0JBQTlCLE1BQU07Z0JBRXNDLE1BQU07c0JBQWxELGVBQWU7dUJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9jdXNLZXlNYW5hZ2VyIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2ExMXknO1xuaW1wb3J0IHsgRGlyZWN0aW9uYWxpdHkgfSBmcm9tICdAYW5ndWxhci9jZGsvYmlkaSc7XG5pbXBvcnQgeyBFTkQsIEVOVEVSLCBIT01FLCBTUEFDRSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9rZXljb2Rlcyc7XG5pbXBvcnQge1xuICAgIEFmdGVyQ29udGVudEluaXQsXG4gICAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgQ29tcG9uZW50LFxuICAgIENvbnRlbnRDaGlsZHJlbixcbiAgICBFbGVtZW50UmVmLFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBJbnB1dCxcbiAgICBPcHRpb25hbCxcbiAgICBPdXRwdXQsXG4gICAgUXVlcnlMaXN0LFxuICAgIFZpZXdDaGlsZCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE54U2Nyb2xsYWJsZVRhYkJhciB9IGZyb20gJy4vc2Nyb2xsYWJsZS10YWItYmFyJztcbmltcG9ydCB7IE54VGFiR3JvdXBCYXNlIH0gZnJvbSAnLi90YWItZ3JvdXAtYmFzZSc7XG5pbXBvcnQgeyBOeFRhYkxhYmVsV3JhcHBlckRpcmVjdGl2ZSB9IGZyb20gJy4vdGFiLWxhYmVsLXdyYXBwZXInO1xuXG4vKiogQGRvY3MtcHJpdmF0ZSAqL1xuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdueC10YWItaGVhZGVyJyxcbiAgICB0ZW1wbGF0ZVVybDogJ3RhYi1oZWFkZXIuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vdGFiLWhlYWRlci5zY3NzJ10sXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gICAgaG9zdDoge1xuICAgICAgICAnW2NsYXNzLmF0LXN0YXJ0XSc6ICdfaXNTY3JvbGxlZFRvU3RhcnQnLFxuICAgICAgICAnW2NsYXNzLnNjcm9sbGFibGVdJzogJ3Njcm9sbGFibGUnLFxuICAgIH0sXG59KVxuZXhwb3J0IGNsYXNzIE54VGFiSGVhZGVyQ29tcG9uZW50IGV4dGVuZHMgTnhTY3JvbGxhYmxlVGFiQmFyIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG4gICAgcHJpdmF0ZSBfa2V5TWFuYWdlciE6IEZvY3VzS2V5TWFuYWdlcjxOeFRhYkxhYmVsV3JhcHBlckRpcmVjdGl2ZT47XG5cbiAgICBAVmlld0NoaWxkKCd0YWJzTGlzdCcpIHNjcm9sbGFibGVUYWJzTGlzdCE6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+O1xuICAgIEBDb250ZW50Q2hpbGRyZW4oJ3RhYkJ1dHRvbicpIHRhYkJ1dHRvbnMhOiBRdWVyeUxpc3Q8SFRNTEVsZW1lbnQ+O1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0ZWRJbmRleCA9IDA7XG5cbiAgICBASW5wdXQoKVxuICAgIGdldCBzZWxlY3RlZEluZGV4KCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zZWxlY3RlZEluZGV4O1xuICAgIH1cbiAgICBzZXQgc2VsZWN0ZWRJbmRleCh2YWx1ZTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuX3NlbGVjdGVkSW5kZXggPSB2YWx1ZTtcbiAgICAgICAgaWYgKHRoaXMuX2tleU1hbmFnZXIpIHtcbiAgICAgICAgICAgIHRoaXMuX2tleU1hbmFnZXIudXBkYXRlQWN0aXZlSXRlbSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXQgZm9jdXNJbmRleCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fa2V5TWFuYWdlciA/ICh0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW1JbmRleCBhcyBudW1iZXIpIDogMDtcbiAgICB9XG4gICAgc2V0IGZvY3VzSW5kZXgodmFsdWU6IG51bWJlcikge1xuICAgICAgICBpZiAoIXRoaXMuX2lzVmFsaWRJbmRleCh2YWx1ZSkgfHwgdGhpcy5mb2N1c0luZGV4ID09PSB2YWx1ZSB8fCAhdGhpcy5fa2V5TWFuYWdlcikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2tleU1hbmFnZXIuc2V0QWN0aXZlSXRlbSh2YWx1ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfYXV0b3NlbGVjdCA9IHRydWU7XG5cbiAgICBASW5wdXQoKVxuICAgIGdldCBhdXRvc2VsZWN0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fYXV0b3NlbGVjdDtcbiAgICB9XG4gICAgc2V0IGF1dG9zZWxlY3QodmFsdWU6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5fYXV0b3NlbGVjdCA9IHZhbHVlO1xuICAgIH1cblxuICAgIEBPdXRwdXQoKSByZWFkb25seSBzZWxlY3RGb2N1c2VkSW5kZXg6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gICAgQE91dHB1dCgpIHJlYWRvbmx5IGluZGV4Rm9jdXNlZDogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcblxuICAgIEBDb250ZW50Q2hpbGRyZW4oTnhUYWJMYWJlbFdyYXBwZXJEaXJlY3RpdmUpIGxhYmVscyE6IFF1ZXJ5TGlzdDxOeFRhYkxhYmVsV3JhcHBlckRpcmVjdGl2ZT47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIF9jZHI6IENoYW5nZURldGVjdG9yUmVmLFxuICAgICAgICBAT3B0aW9uYWwoKSBfZGlyOiBEaXJlY3Rpb25hbGl0eSB8IG51bGwsXG4gICAgICAgIEBPcHRpb25hbCgpIHB1YmxpYyBfdGFiR3JvdXA6IE54VGFiR3JvdXBCYXNlIHwgbnVsbCxcbiAgICAgICAgX2VsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgKSB7XG4gICAgICAgIHN1cGVyKF9jZHIsIF9kaXIsIF9lbGVtZW50KTtcbiAgICB9XG5cbiAgICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgICAgIHN1cGVyLm5nQWZ0ZXJDb250ZW50SW5pdCgpO1xuICAgICAgICB0aGlzLl9rZXlNYW5hZ2VyID0gbmV3IEZvY3VzS2V5TWFuYWdlcjxOeFRhYkxhYmVsV3JhcHBlckRpcmVjdGl2ZT4odGhpcy5sYWJlbHMpLndpdGhIb3Jpem9udGFsT3JpZW50YXRpb24oJ2x0cicpLndpdGhXcmFwKCk7XG4gICAgICAgIHRoaXMuX2tleU1hbmFnZXIudXBkYXRlQWN0aXZlSXRlbSgwKTtcbiAgICAgICAgdGhpcy5fY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgIH1cbiAgICBwcml2YXRlIF9pc1ZhbGlkSW5kZXgoaWR4OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLmxhYmVscykge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGFiID0gdGhpcy5sYWJlbHMudG9BcnJheSgpW2lkeF0gfHwgbnVsbDtcbiAgICAgICAgcmV0dXJuICEhdGFiICYmICF0YWIuZGlzYWJsZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyBrZXlib2FyZCBpbnB1dHMgb24gdGhlIGxhYmVsc1xuICAgICAqIElmIGF1dG9zZWxlY3QgaXMgZW5hYmxlZCB0aGUgdGFiIGdldHMgY2hhbmdlZCBpbW1lZGlhdGVseVxuICAgICAqIElmIGF1dG9zZWxlY3QgaXMgZGlzYWJsZWQgb25seSB0aGUgZm9jdXMgY2hhbmdlcyBidXQgdGhlIHVzZXIgc3RpbGwgaGFzIHRvIHNlbGVjdCB0aGUgaXRlbVxuICAgICAqIGJ5IGhpbXNlbGZcbiAgICAgKi9cbiAgICBoYW5kbGVLZXlkb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgIHN3aXRjaCAoZXZlbnQua2V5Q29kZSkge1xuICAgICAgICAgICAgY2FzZSBIT01FOlxuICAgICAgICAgICAgICAgIHRoaXMuX2tleU1hbmFnZXIuc2V0Rmlyc3RJdGVtQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgRU5EOlxuICAgICAgICAgICAgICAgIHRoaXMuX2tleU1hbmFnZXIuc2V0TGFzdEl0ZW1BY3RpdmUoKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBFTlRFUjpcbiAgICAgICAgICAgIGNhc2UgU1BBQ0U6XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RGb2N1c2VkSW5kZXguZW1pdCh0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW1JbmRleCBhcyBudW1iZXIpO1xuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRoaXMuX2tleU1hbmFnZXIub25LZXlkb3duKGV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmF1dG9zZWxlY3QpIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0Rm9jdXNlZEluZGV4LmVtaXQodGhpcy5fa2V5TWFuYWdlci5hY3RpdmVJdGVtSW5kZXggYXMgbnVtYmVyKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5rZXlDb2RlICE9PSBFTlRFUiAmJiBldmVudC5rZXlDb2RlICE9PSBTUEFDRSkge1xuICAgICAgICAgICAgdGhpcy5pbmRleEZvY3VzZWQuZW1pdCh0aGlzLl9rZXlNYW5hZ2VyLmFjdGl2ZUl0ZW1JbmRleCBhcyBudW1iZXIpO1xuICAgICAgICB9XG4gICAgfVxufVxuIiwiPG54LXRhYi1zY3JvbGwtaW5kaWNhdG9yICpuZ0lmPVwic2Nyb2xsYWJsZVwiIHNjcm9sbERpcmVjdGlvbj1cInN0YXJ0XCIgW2lzU2Nyb2xsZWRUb1N0YXJ0XT1cIl9pc1Njcm9sbGVkVG9TdGFydFwiIChidXR0b25DbGlja2VkKT1cInNjcm9sbFRvU3RhcnQoKVwiPlxuPC9ueC10YWItc2Nyb2xsLWluZGljYXRvcj5cbjxkaXYgI3RhYnNMaXN0IGNsYXNzPVwibngtdGFiLWhlYWRlclwiIChrZXlkb3duKT1cImhhbmRsZUtleWRvd24oJGV2ZW50KVwiIHJvbGU9XCJ0YWJsaXN0XCIgdGFiaW5kZXg9XCItMVwiPlxuICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbjwvZGl2PlxuPG54LXRhYi1zY3JvbGwtaW5kaWNhdG9yICpuZ0lmPVwic2Nyb2xsYWJsZVwiIHNjcm9sbERpcmVjdGlvbj1cImVuZFwiIFtpc1Njcm9sbGVkVG9FbmRdPVwiX2lzU2Nyb2xsZWRUb0VuZFwiIChidXR0b25DbGlja2VkKT1cInNjcm9sbFRvRW5kKClcIj5cbjwvbngtdGFiLXNjcm9sbC1pbmRpY2F0b3I+XG4iXX0=