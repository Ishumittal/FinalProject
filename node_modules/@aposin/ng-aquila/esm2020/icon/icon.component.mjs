import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { ChangeDetectionStrategy, Component, Input } from '@angular/core';
import { take } from 'rxjs/operators';
import { cloneSvg } from './icon-registry';
import { NxSvgIcon } from './icons';
import * as i0 from "@angular/core";
import * as i1 from "./icon-registry";
export class NxIconComponent {
    constructor(/** @docs-private */ el, _iconRegistry) {
        this.el = el;
        this._iconRegistry = _iconRegistry;
        this._name = '';
        this._previousFontClasses = [];
        this._outline = false;
        this._fill = false;
        this._size = 'auto';
        /** Sets the font name that should be used. */
        this.font = '';
    }
    /** Sets the name for specifying the icon.*/
    set name(name) {
        this._name = name;
    }
    get name() {
        return this._name;
    }
    /** Whether the icon has an outline. */
    set outline(value) {
        this._outline = coerceBooleanProperty(value);
    }
    get outline() {
        return this._outline;
    }
    /** Whether the icon is filled. */
    set fill(value) {
        this._fill = coerceBooleanProperty(value);
    }
    get fill() {
        return this._fill;
    }
    /** Specifies the size of the icon. */
    set size(value) {
        if (this._size === value) {
            return;
        }
        this._size = value;
        this.el.nativeElement.classList.add('nx-icon--' + this.size);
    }
    get size() {
        return this._size;
    }
    ngOnChanges(changes) {
        if (changes['name'] || changes['font']) {
            this.renderIcon();
        }
    }
    renderIcon() {
        const icon = this._iconRegistry.getIcon(this.name);
        if (!icon) {
            // here we fall back to the icon class so we look at the `font` input
            // or take the default font
            this._updateFontIconClasses();
            this._clearSvgElement();
        }
        else if (icon instanceof NxSvgIcon) {
            // add content
            icon.getContent()
                .pipe(take(1))
                .subscribe((content) => {
                if (!content) {
                    return;
                }
                // we need to clone the svg here otherwise when you have the same icon
                // multiple times it would end up only in the last icon that got created
                this._setSvgElement(cloneSvg(content));
            });
        }
        else {
            // here we have to look at the alias as well that could come from the registry
            this._updateFontIconClassesFromOverride(icon.alias, icon.font);
            this._clearSvgElement();
        }
    }
    _setSvgElement(svg) {
        this._clearSvgElement();
        // Workaround for IE11 and Edge ignoring `style` tags inside dynamically-created SVGs.
        // See: https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/10898469/
        // Do this before inserting the element into the DOM, in order to avoid a style recalculation.
        const styleTags = svg.querySelectorAll('style');
        for (let i = 0; i < styleTags.length; i++) {
            styleTags[i].textContent += ' ';
        }
        this._removePreviousFontClasses();
        this.el.nativeElement.appendChild(svg);
    }
    _clearSvgElement() {
        const layoutElement = this.el.nativeElement;
        let childCount = layoutElement.childNodes.length;
        if (this._elementsWithExternalReferences) {
            this._elementsWithExternalReferences.clear();
        }
        // Remove existing non-element child nodes and SVGs, and add the new SVG element. Note that
        // we can't use innerHTML, because IE will throw if the element has a data binding.
        while (childCount--) {
            const child = layoutElement.childNodes[childCount];
            // 1 corresponds to Node.ELEMENT_NODE. We remove all non-element nodes in order to get rid
            // of any loose text nodes, as well as any SVG elements in order to remove any old icons.
            if (child.nodeType !== 1 || child.nodeName.toLowerCase() === 'svg') {
                layoutElement.removeChild(child);
            }
        }
    }
    _updateFontIconClassesFromOverride(alias, font) {
        const name = alias ? alias : this.name;
        this._setFontIconClasses([font.hostClass, font.prefix + name]);
    }
    _updateFontIconClasses() {
        const font = this.font ? this._iconRegistry.getFont(this.font) : this._iconRegistry.getDefaultFont();
        const hostClass = font ? font.hostClass : '';
        const name = font ? font.prefix + this.name : this.name;
        this._setFontIconClasses([hostClass, name]);
    }
    _setFontIconClasses(classes) {
        // filters empty classes as they cannot be added via classList.add
        const filteredClasses = classes.filter(c => c !== '');
        const elem = this.el.nativeElement;
        this._removePreviousFontClasses();
        this._previousFontClasses = filteredClasses;
        filteredClasses.forEach(cl => elem.classList.add(cl));
    }
    _removePreviousFontClasses() {
        if (!this._previousFontClasses) {
            return;
        }
        this._previousFontClasses.forEach(cl => {
            // IE11 doesn't support multiple paramaters in remove or add
            // so we can't use the spread operator here
            this.el.nativeElement.classList.remove(cl);
        });
    }
}
NxIconComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxIconComponent, deps: [{ token: i0.ElementRef }, { token: i1.NxIconRegistry }], target: i0.ɵɵFactoryTarget.Component });
NxIconComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.1", type: NxIconComponent, selector: "nx-icon", inputs: { name: "name", outline: "outline", fill: "fill", size: "size", font: "font" }, host: { properties: { "class.nx-icon--outline": "outline", "class.nx-icon--fill": "fill", "class.nx-icon--auto": "size === \"auto\"" } }, usesOnChanges: true, ngImport: i0, template: '', isInline: true, styles: [":host{speak:none;text-transform:none;line-height:1;display:inline-flex;align-items:center;justify-content:center;letter-spacing:normal;text-align:center;width:1em;height:1em}:host ::ng-deep svg{width:1em;height:1em;fill:currentColor;flex:0 0 auto}:host:before{font-size:inherit;width:1em;height:1em}@media screen and (-ms-high-contrast: active){:host{color:inherit!important}}:host(.nx-icon--auto){font-size:inherit}:host(.nx-icon--s){font-size:24px}:host(.nx-icon--m){font-size:48px}:host(.nx-icon--l){font-size:72px}:host(.nx-icon--xl){font-size:96px}:host(.nx-icon--outline){border-radius:50%;border:solid;width:2em;height:2em;border-width:1px}:host(.nx-icon--outline).nx-icon--s{border-width:1px;width:40px;height:40px}:host(.nx-icon--outline).nx-icon--m{border-width:2px;width:80px;height:80px}:host(.nx-icon--outline).nx-icon--l{border-width:3px;width:120px;height:120px}:host(.nx-icon--outline).nx-icon--xl{border-width:4px;width:160px;height:160px}:host(.nx-icon--fill){border-radius:50%;border-color:transparent;width:2em;height:2em;background:var(--icon-filled-background-color);color:var(--icon-filled-color)}:host(.nx-icon--fill).nx-icon--s{width:40px;height:40px}:host(.nx-icon--fill).nx-icon--m{width:80px;height:80px}:host(.nx-icon--fill).nx-icon--l{width:120px;height:120px}:host(.nx-icon--fill).nx-icon--xl{width:160px;height:160px}\n"], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxIconComponent, decorators: [{
            type: Component,
            args: [{ selector: 'nx-icon', template: '', changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        '[class.nx-icon--outline]': 'outline',
                        '[class.nx-icon--fill]': 'fill',
                        '[class.nx-icon--auto]': 'size === "auto"',
                    }, styles: [":host{speak:none;text-transform:none;line-height:1;display:inline-flex;align-items:center;justify-content:center;letter-spacing:normal;text-align:center;width:1em;height:1em}:host ::ng-deep svg{width:1em;height:1em;fill:currentColor;flex:0 0 auto}:host:before{font-size:inherit;width:1em;height:1em}@media screen and (-ms-high-contrast: active){:host{color:inherit!important}}:host(.nx-icon--auto){font-size:inherit}:host(.nx-icon--s){font-size:24px}:host(.nx-icon--m){font-size:48px}:host(.nx-icon--l){font-size:72px}:host(.nx-icon--xl){font-size:96px}:host(.nx-icon--outline){border-radius:50%;border:solid;width:2em;height:2em;border-width:1px}:host(.nx-icon--outline).nx-icon--s{border-width:1px;width:40px;height:40px}:host(.nx-icon--outline).nx-icon--m{border-width:2px;width:80px;height:80px}:host(.nx-icon--outline).nx-icon--l{border-width:3px;width:120px;height:120px}:host(.nx-icon--outline).nx-icon--xl{border-width:4px;width:160px;height:160px}:host(.nx-icon--fill){border-radius:50%;border-color:transparent;width:2em;height:2em;background:var(--icon-filled-background-color);color:var(--icon-filled-color)}:host(.nx-icon--fill).nx-icon--s{width:40px;height:40px}:host(.nx-icon--fill).nx-icon--m{width:80px;height:80px}:host(.nx-icon--fill).nx-icon--l{width:120px;height:120px}:host(.nx-icon--fill).nx-icon--xl{width:160px;height:160px}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.NxIconRegistry }]; }, propDecorators: { name: [{
                type: Input
            }], outline: [{
                type: Input
            }], fill: [{
                type: Input
            }], size: [{
                type: Input
            }], font: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1hcXVpbGEvc3JjL2ljb24vaWNvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFnQixxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzVFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQWMsS0FBSyxFQUE0QixNQUFNLGVBQWUsQ0FBQztBQUNoSCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEMsT0FBTyxFQUFFLFFBQVEsRUFBd0MsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7QUFnQnBDLE1BQU0sT0FBTyxlQUFlO0lBdUR4QixZQUFZLG9CQUFvQixDQUFRLEVBQWMsRUFBVSxhQUE2QjtRQUFyRCxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBcERyRixVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gseUJBQW9CLEdBQWEsRUFBRSxDQUFDO1FBWXBDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFVakIsVUFBSyxHQUFHLEtBQUssQ0FBQztRQVVkLFVBQUssR0FBYSxNQUFNLENBQUM7UUFnQmpDLDhDQUE4QztRQUNyQyxTQUFJLEdBQUcsRUFBRSxDQUFDO0lBRTZFLENBQUM7SUFqRGpHLDRDQUE0QztJQUM1QyxJQUNJLElBQUksQ0FBQyxJQUFZO1FBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQ3RCLENBQUM7SUFFRCxJQUFJLElBQUk7UUFDSixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUdELHVDQUF1QztJQUN2QyxJQUNJLE9BQU8sQ0FBQyxLQUFtQjtRQUMzQixJQUFJLENBQUMsUUFBUSxHQUFHLHFCQUFx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aUJBQWlCO3FCQUM3Qzs4SEFVRyxJQUFJO3NCQURQLEtBQUs7Z0JBWUYsT0FBTztzQkFEVixLQUFLO2dCQVdGLElBQUk7c0JBRFAsS0FBSztnQkFZRixJQUFJO3NCQURQLEtBQUs7Z0JBY0csSUFBSTtzQkFBWixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9vbGVhbklucHV0LCBjb2VyY2VCb29sZWFuUHJvcGVydHkgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgY2xvbmVTdmcsIE54SWNvbkZvbnREZWZpbml0aW9uLCBOeEljb25SZWdpc3RyeSB9IGZyb20gJy4vaWNvbi1yZWdpc3RyeSc7XG5pbXBvcnQgeyBOeFN2Z0ljb24gfSBmcm9tICcuL2ljb25zJztcblxuLyoqIFR5cGVzIG9mIGljb24gc2l6ZXMgKi9cbmV4cG9ydCB0eXBlIEljb25TaXplID0gJ2F1dG8nIHwgJ3MnIHwgJ20nIHwgJ2wnIHwgJ3hsJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdueC1pY29uJyxcbiAgICB0ZW1wbGF0ZTogJycsXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gICAgc3R5bGVVcmxzOiBbJy4vaWNvbi5jb21wb25lbnQuc2NzcyddLFxuICAgIGhvc3Q6IHtcbiAgICAgICAgJ1tjbGFzcy5ueC1pY29uLS1vdXRsaW5lXSc6ICdvdXRsaW5lJyxcbiAgICAgICAgJ1tjbGFzcy5ueC1pY29uLS1maWxsXSc6ICdmaWxsJyxcbiAgICAgICAgJ1tjbGFzcy5ueC1pY29uLS1hdXRvXSc6ICdzaXplID09PSBcImF1dG9cIicsXG4gICAgfSxcbn0pXG5leHBvcnQgY2xhc3MgTnhJY29uQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbiAgICAvKiogS2VlcHMgdHJhY2sgb2YgdGhlIGVsZW1lbnRzIGFuZCBhdHRyaWJ1dGVzIHRoYXQgd2UndmUgcHJlZml4ZWQgd2l0aCB0aGUgY3VycmVudCBwYXRoLiAqL1xuICAgIHByaXZhdGUgX2VsZW1lbnRzV2l0aEV4dGVybmFsUmVmZXJlbmNlcz86IE1hcDxFbGVtZW50LCB7IG5hbWU6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9W10+O1xuICAgIHByaXZhdGUgX25hbWUgPSAnJztcbiAgICBwcml2YXRlIF9wcmV2aW91c0ZvbnRDbGFzc2VzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLyoqIFNldHMgdGhlIG5hbWUgZm9yIHNwZWNpZnlpbmcgdGhlIGljb24uKi9cbiAgICBASW5wdXQoKVxuICAgIHNldCBuYW1lKG5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9uYW1lID0gbmFtZTtcbiAgICB9XG5cbiAgICBnZXQgbmFtZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fbmFtZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9vdXRsaW5lID0gZmFsc2U7XG4gICAgLyoqIFdoZXRoZXIgdGhlIGljb24gaGFzIGFuIG91dGxpbmUuICovXG4gICAgQElucHV0KClcbiAgICBzZXQgb3V0bGluZSh2YWx1ZTogQm9vbGVhbklucHV0KSB7XG4gICAgICAgIHRoaXMuX291dGxpbmUgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkodmFsdWUpO1xuICAgIH1cbiAgICBnZXQgb3V0bGluZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX291dGxpbmU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZmlsbCA9IGZhbHNlO1xuICAgIC8qKiBXaGV0aGVyIHRoZSBpY29uIGlzIGZpbGxlZC4gKi9cbiAgICBASW5wdXQoKVxuICAgIHNldCBmaWxsKHZhbHVlOiBCb29sZWFuSW5wdXQpIHtcbiAgICAgICAgdGhpcy5fZmlsbCA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSh2YWx1ZSk7XG4gICAgfVxuICAgIGdldCBmaWxsKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmlsbDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zaXplOiBJY29uU2l6ZSA9ICdhdXRvJztcblxuICAgIC8qKiBTcGVjaWZpZXMgdGhlIHNpemUgb2YgdGhlIGljb24uICovXG4gICAgQElucHV0KClcbiAgICBzZXQgc2l6ZSh2YWx1ZTogSWNvblNpemUpIHtcbiAgICAgICAgaWYgKHRoaXMuX3NpemUgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fc2l6ZSA9IHZhbHVlO1xuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnbngtaWNvbi0tJyArIHRoaXMuc2l6ZSk7XG4gICAgfVxuXG4gICAgZ2V0IHNpemUoKTogSWNvblNpemUge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2l6ZTtcbiAgICB9XG5cbiAgICAvKiogU2V0cyB0aGUgZm9udCBuYW1lIHRoYXQgc2hvdWxkIGJlIHVzZWQuICovXG4gICAgQElucHV0KCkgZm9udCA9ICcnO1xuXG4gICAgY29uc3RydWN0b3IoLyoqIEBkb2NzLXByaXZhdGUgKi8gcHVibGljIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIF9pY29uUmVnaXN0cnk6IE54SWNvblJlZ2lzdHJ5KSB7fVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAoY2hhbmdlc1snbmFtZSddIHx8IGNoYW5nZXNbJ2ZvbnQnXSkge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJJY29uKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlckljb24oKSB7XG4gICAgICAgIGNvbnN0IGljb24gPSB0aGlzLl9pY29uUmVnaXN0cnkuZ2V0SWNvbih0aGlzLm5hbWUpO1xuICAgICAgICBpZiAoIWljb24pIHtcbiAgICAgICAgICAgIC8vIGhlcmUgd2UgZmFsbCBiYWNrIHRvIHRoZSBpY29uIGNsYXNzIHNvIHdlIGxvb2sgYXQgdGhlIGBmb250YCBpbnB1dFxuICAgICAgICAgICAgLy8gb3IgdGFrZSB0aGUgZGVmYXVsdCBmb250XG4gICAgICAgICAgICB0aGlzLl91cGRhdGVGb250SWNvbkNsYXNzZXMoKTtcbiAgICAgICAgICAgIHRoaXMuX2NsZWFyU3ZnRWxlbWVudCgpO1xuICAgICAgICB9IGVsc2UgaWYgKGljb24gaW5zdGFuY2VvZiBOeFN2Z0ljb24pIHtcbiAgICAgICAgICAgIC8vIGFkZCBjb250ZW50XG4gICAgICAgICAgICBpY29uLmdldENvbnRlbnQoKVxuICAgICAgICAgICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoY29udGVudD86IFNWR0VsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGNsb25lIHRoZSBzdmcgaGVyZSBvdGhlcndpc2Ugd2hlbiB5b3UgaGF2ZSB0aGUgc2FtZSBpY29uXG4gICAgICAgICAgICAgICAgICAgIC8vIG11bHRpcGxlIHRpbWVzIGl0IHdvdWxkIGVuZCB1cCBvbmx5IGluIHRoZSBsYXN0IGljb24gdGhhdCBnb3QgY3JlYXRlZFxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXRTdmdFbGVtZW50KGNsb25lU3ZnKGNvbnRlbnQpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGhlcmUgd2UgaGF2ZSB0byBsb29rIGF0IHRoZSBhbGlhcyBhcyB3ZWxsIHRoYXQgY291bGQgY29tZSBmcm9tIHRoZSByZWdpc3RyeVxuICAgICAgICAgICAgdGhpcy5fdXBkYXRlRm9udEljb25DbGFzc2VzRnJvbU92ZXJyaWRlKGljb24uYWxpYXMsIGljb24uZm9udCk7XG4gICAgICAgICAgICB0aGlzLl9jbGVhclN2Z0VsZW1lbnQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3NldFN2Z0VsZW1lbnQoc3ZnOiBTVkdFbGVtZW50KSB7XG4gICAgICAgIHRoaXMuX2NsZWFyU3ZnRWxlbWVudCgpO1xuICAgICAgICAvLyBXb3JrYXJvdW5kIGZvciBJRTExIGFuZCBFZGdlIGlnbm9yaW5nIGBzdHlsZWAgdGFncyBpbnNpZGUgZHluYW1pY2FsbHktY3JlYXRlZCBTVkdzLlxuICAgICAgICAvLyBTZWU6IGh0dHBzOi8vZGV2ZWxvcGVyLm1pY3Jvc29mdC5jb20vZW4tdXMvbWljcm9zb2Z0LWVkZ2UvcGxhdGZvcm0vaXNzdWVzLzEwODk4NDY5L1xuICAgICAgICAvLyBEbyB0aGlzIGJlZm9yZSBpbnNlcnRpbmcgdGhlIGVsZW1lbnQgaW50byB0aGUgRE9NLCBpbiBvcmRlciB0byBhdm9pZCBhIHN0eWxlIHJlY2FsY3VsYXRpb24uXG4gICAgICAgIGNvbnN0IHN0eWxlVGFncyA9IHN2Zy5xdWVyeVNlbGVjdG9yQWxsKCdzdHlsZScpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3R5bGVUYWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBzdHlsZVRhZ3NbaV0udGV4dENvbnRlbnQgKz0gJyAnO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3JlbW92ZVByZXZpb3VzRm9udENsYXNzZXMoKTtcbiAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmFwcGVuZENoaWxkKHN2Zyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2xlYXJTdmdFbGVtZW50KCkge1xuICAgICAgICBjb25zdCBsYXlvdXRFbGVtZW50OiBIVE1MRWxlbWVudCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgICAgICAgbGV0IGNoaWxkQ291bnQgPSBsYXlvdXRFbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoO1xuXG4gICAgICAgIGlmICh0aGlzLl9lbGVtZW50c1dpdGhFeHRlcm5hbFJlZmVyZW5jZXMpIHtcbiAgICAgICAgICAgIHRoaXMuX2VsZW1lbnRzV2l0aEV4dGVybmFsUmVmZXJlbmNlcy5jbGVhcigpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIGV4aXN0aW5nIG5vbi1lbGVtZW50IGNoaWxkIG5vZGVzIGFuZCBTVkdzLCBhbmQgYWRkIHRoZSBuZXcgU1ZHIGVsZW1lbnQuIE5vdGUgdGhhdFxuICAgICAgICAvLyB3ZSBjYW4ndCB1c2UgaW5uZXJIVE1MLCBiZWNhdXNlIElFIHdpbGwgdGhyb3cgaWYgdGhlIGVsZW1lbnQgaGFzIGEgZGF0YSBiaW5kaW5nLlxuICAgICAgICB3aGlsZSAoY2hpbGRDb3VudC0tKSB7XG4gICAgICAgICAgICBjb25zdCBjaGlsZCA9IGxheW91dEVsZW1lbnQuY2hpbGROb2Rlc1tjaGlsZENvdW50XTtcblxuICAgICAgICAgICAgLy8gMSBjb3JyZXNwb25kcyB0byBOb2RlLkVMRU1FTlRfTk9ERS4gV2UgcmVtb3ZlIGFsbCBub24tZWxlbWVudCBub2RlcyBpbiBvcmRlciB0byBnZXQgcmlkXG4gICAgICAgICAgICAvLyBvZiBhbnkgbG9vc2UgdGV4dCBub2RlcywgYXMgd2VsbCBhcyBhbnkgU1ZHIGVsZW1lbnRzIGluIG9yZGVyIHRvIHJlbW92ZSBhbnkgb2xkIGljb25zLlxuICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlICE9PSAxIHx8IGNoaWxkLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzdmcnKSB7XG4gICAgICAgICAgICAgICAgbGF5b3V0RWxlbWVudC5yZW1vdmVDaGlsZChjaGlsZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF91cGRhdGVGb250SWNvbkNsYXNzZXNGcm9tT3ZlcnJpZGUoYWxpYXM6IHN0cmluZywgZm9udDogTnhJY29uRm9udERlZmluaXRpb24pIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IGFsaWFzID8gYWxpYXMgOiB0aGlzLm5hbWU7XG4gICAgICAgIHRoaXMuX3NldEZvbnRJY29uQ2xhc3NlcyhbZm9udC5ob3N0Q2xhc3MsIGZvbnQucHJlZml4ICsgbmFtZV0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3VwZGF0ZUZvbnRJY29uQ2xhc3NlcygpIHtcbiAgICAgICAgY29uc3QgZm9udCA9IHRoaXMuZm9udCA/IHRoaXMuX2ljb25SZWdpc3RyeS5nZXRGb250KHRoaXMuZm9udCkgOiB0aGlzLl9pY29uUmVnaXN0cnkuZ2V0RGVmYXVsdEZvbnQoKTtcbiAgICAgICAgY29uc3QgaG9zdENsYXNzID0gZm9udCA/IGZvbnQuaG9zdENsYXNzIDogJyc7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBmb250ID8gZm9udC5wcmVmaXggKyB0aGlzLm5hbWUgOiB0aGlzLm5hbWU7XG4gICAgICAgIHRoaXMuX3NldEZvbnRJY29uQ2xhc3NlcyhbaG9zdENsYXNzLCBuYW1lXSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2V0Rm9udEljb25DbGFzc2VzKGNsYXNzZXM6IHN0cmluZ1tdKSB7XG4gICAgICAgIC8vIGZpbHRlcnMgZW1wdHkgY2xhc3NlcyBhcyB0aGV5IGNhbm5vdCBiZSBhZGRlZCB2aWEgY2xhc3NMaXN0LmFkZFxuICAgICAgICBjb25zdCBmaWx0ZXJlZENsYXNzZXMgPSBjbGFzc2VzLmZpbHRlcihjID0+IGMgIT09ICcnKTtcblxuICAgICAgICBjb25zdCBlbGVtOiBIVE1MRWxlbWVudCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcblxuICAgICAgICB0aGlzLl9yZW1vdmVQcmV2aW91c0ZvbnRDbGFzc2VzKCk7XG4gICAgICAgIHRoaXMuX3ByZXZpb3VzRm9udENsYXNzZXMgPSBmaWx0ZXJlZENsYXNzZXM7XG4gICAgICAgIGZpbHRlcmVkQ2xhc3Nlcy5mb3JFYWNoKGNsID0+IGVsZW0uY2xhc3NMaXN0LmFkZChjbCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3JlbW92ZVByZXZpb3VzRm9udENsYXNzZXMoKSB7XG4gICAgICAgIGlmICghdGhpcy5fcHJldmlvdXNGb250Q2xhc3Nlcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3ByZXZpb3VzRm9udENsYXNzZXMuZm9yRWFjaChjbCA9PiB7XG4gICAgICAgICAgICAvLyBJRTExIGRvZXNuJ3Qgc3VwcG9ydCBtdWx0aXBsZSBwYXJhbWF0ZXJzIGluIHJlbW92ZSBvciBhZGRcbiAgICAgICAgICAgIC8vIHNvIHdlIGNhbid0IHVzZSB0aGUgc3ByZWFkIG9wZXJhdG9yIGhlcmVcbiAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKGNsKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19