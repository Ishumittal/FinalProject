import { forkJoin, of, Subject } from 'rxjs';
import { catchError } from 'rxjs/operators';
export class NxFileUploadSuccess {
    constructor(
    /** The files that were successfully uploaded. */
    files, 
    /** The results of the request(s). */
    requests) {
        this.files = files;
        this.requests = requests;
    }
}
export class NxFileUploadError {
    constructor(
    /** The files that had an error while uploading. */
    files, 
    /** The returned errors of the request(s). */
    requests) {
        this.files = files;
        this.requests = requests;
    }
}
export class NxFileUploader {
    constructor(config, http) {
        /** Stream that emits the result of an upload request. */
        this.response = new Subject();
        this._config = config;
        this._httpClient = http;
    }
    /** Sets the config options for http requests for uploading the files. */
    set config(options) {
        if (this._config !== options) {
            this._config = options;
        }
    }
    get config() {
        return this._config;
    }
    /** Uploads the files to the url specified in config. */
    uploadFiles(files) {
        if (this.config['uploadSeparately']) {
            this._uploadFilesSeparately(files);
        }
        else {
            this._uploadFilesCollectively(files);
        }
    }
    /** Uploads all files with a POST request to the url specified in config. */
    _uploadFilesCollectively(files) {
        // get a list of all files; if there is no one: return
        if (!files || files.length === 0) {
            return;
        }
        const formData = new FormData();
        // save value here in case that it changes while request is running
        const valuesToUpload = files.filter(file => !file.isUploaded);
        valuesToUpload.forEach((file) => {
            file.setUploadingState();
            formData.append('uploads[]', file.file, file.name);
        });
        this._httpClient.post(this.config['requestUrl'], formData, this.config['options']).subscribe(data => {
            valuesToUpload.forEach((file) => file.setUploadedState());
            this.response.next({ allSucessful: true, success: new NxFileUploadSuccess(valuesToUpload, [data]) });
        }, error => {
            valuesToUpload.forEach((file) => file.setErrorState());
            this.response.next({ error: new NxFileUploadError(valuesToUpload, [error]) });
        });
    }
    /**
     * Uploads all files with a POST request to the url specified in config.
     *
     * Each file is uploaded with an individual request.
     */
    _uploadFilesSeparately(files) {
        // get a list of all files; if there is no one: return
        if (!files) {
            return;
        }
        const responses = [];
        const filesToUpload = files.filter(file => !file.isUploaded);
        filesToUpload.forEach((file) => {
            responses.push(this._uploadFile(file).pipe(catchError(error => of(error))));
        });
        forkJoin(responses).subscribe(results => {
            const mergedResults = results.reduce((acc, result) => {
                if (result.success) {
                    if (!acc.success) {
                        acc.success = new NxFileUploadSuccess([], []);
                    }
                    acc.success.files.push(...result.success.files);
                    acc.success.requests.push(...result.success.requests);
                }
                else if (result.error) {
                    if (!acc.error) {
                        acc.error = new NxFileUploadError([], []);
                    }
                    acc.error.files.push(...result.error.files);
                    acc.error.requests.push(...result.error.requests);
                }
                return acc;
            }, {});
            if (!mergedResults.error) {
                mergedResults.allSucessful = true;
            }
            this.response.next(mergedResults);
        });
    }
    /** Uploads one file with a POST request to the url specified in config. */
    _uploadFile(file) {
        const fileReturnVal = new Subject();
        const formData = new FormData();
        if (!file.isUploaded) {
            file.setUploadingState();
            formData.append('uploads[]', file.file, file.name);
        }
        this._httpClient.post(this.config['requestUrl'], formData, this.config['options']).subscribe(data => {
            file.setUploadedState();
            fileReturnVal.next({ success: new NxFileUploadSuccess([file], [data]) });
            fileReturnVal.complete();
        }, error => {
            file.setErrorState();
            fileReturnVal.next({ error: new NxFileUploadError([file], [error]) });
            fileReturnVal.complete();
        });
        return fileReturnVal;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWFxdWlsYS9zcmMvZmlsZS11cGxvYWRlci9maWxlLXVwbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxRQUFRLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN6RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFhNUMsTUFBTSxPQUFPLG1CQUFtQjtJQUM1QjtJQUNJLGlEQUFpRDtJQUMxQyxLQUFpQjtJQUN4QixxQ0FBcUM7SUFDOUIsUUFBa0I7UUFGbEIsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUVqQixhQUFRLEdBQVIsUUFBUSxDQUFVO0lBQzFCLENBQUM7Q0FDUDtBQUVELE1BQU0sT0FBTyxpQkFBaUI7SUFDMUI7SUFDSSxtREFBbUQ7SUFDNUMsS0FBaUI7SUFDeEIsNkNBQTZDO0lBQ3RDLFFBQWtCO1FBRmxCLFVBQUssR0FBTCxLQUFLLENBQVk7UUFFakIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUMxQixDQUFDO0NBQ1A7QUFXRCxNQUFNLE9BQU8sY0FBYztJQWlCdkIsWUFBWSxNQUEwQixFQUFFLElBQWdCO1FBYnhELHlEQUF5RDtRQUNoRCxhQUFRLEdBQWdDLElBQUksT0FBTyxFQUFzQixDQUFDO1FBYS9FLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzVCLENBQUM7SUFiRCx5RUFBeUU7SUFDekUsSUFBSSxNQUFNLENBQUMsT0FBMkI7UUFDbEMsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLE9BQU8sRUFBRTtZQUMxQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztTQUMxQjtJQUNMLENBQUM7SUFDRCxJQUFJLE1BQU07UUFDTixPQUFPLElBQUksQ0FB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bW9uL2h0dHAnO1xuaW1wb3J0IHsgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBGaWxlSXRlbSB9IGZyb20gJy4vZmlsZS11cGxvYWRlci5tb2RlbCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTnhGaWxlVXBsb2FkQ29uZmlnIHtcbiAgICAvKiogU2V0cyB0aGUgdXJsIGZvciB1cGxvYWRpbmcgcmVxdWVzdHMuICovXG4gICAgcmVxdWVzdFVybDogc3RyaW5nO1xuICAgIC8qKiBTZXRzIHRoZSBvcHRpb25zIGZvciBodHRwIHVwbG9hZCByZXF1ZXN0cy4gSHR0cFBhcmFtcyAqL1xuICAgIG9wdGlvbnM/OiBvYmplY3Q7XG4gICAgLyoqIFdoZXRoZXIgdGhlIGZpbGVzIHNob3VsZCBiZSB1cGxvYWRlZCBzZXBhcmF0ZWx5LiBEZWZhdWx0OiBmYWxzZS4gKi9cbiAgICB1cGxvYWRTZXBhcmF0ZWx5PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIE54RmlsZVVwbG9hZFN1Y2Nlc3Mge1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICAvKiogVGhlIGZpbGVzIHRoYXQgd2VyZSBzdWNjZXNzZnVsbHkgdXBsb2FkZWQuICovXG4gICAgICAgIHB1YmxpYyBmaWxlczogRmlsZUl0ZW1bXSxcbiAgICAgICAgLyoqIFRoZSByZXN1bHRzIG9mIHRoZSByZXF1ZXN0KHMpLiAqL1xuICAgICAgICBwdWJsaWMgcmVxdWVzdHM6IG9iamVjdFtdLFxuICAgICkge31cbn1cblxuZXhwb3J0IGNsYXNzIE54RmlsZVVwbG9hZEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgLyoqIFRoZSBmaWxlcyB0aGF0IGhhZCBhbiBlcnJvciB3aGlsZSB1cGxvYWRpbmcuICovXG4gICAgICAgIHB1YmxpYyBmaWxlczogRmlsZUl0ZW1bXSxcbiAgICAgICAgLyoqIFRoZSByZXR1cm5lZCBlcnJvcnMgb2YgdGhlIHJlcXVlc3QocykuICovXG4gICAgICAgIHB1YmxpYyByZXF1ZXN0czogb2JqZWN0W10sXG4gICAgKSB7fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE54RmlsZVVwbG9hZFJlc3VsdCB7XG4gICAgLyoqIFdoZXRoZXIgYWxsIGZpbGVzIHdlcmUgc3VjY2Vzc2Z1bGx5IHVwbG9hZGVkLiAqL1xuICAgIGFsbFN1Y2Vzc2Z1bD86IGJvb2xlYW47XG4gICAgLyoqIEFsbCBzdWNjZXNzZnVsbHkgdXBsb2FkZWQgcmVzdWx0cy4gKi9cbiAgICBzdWNjZXNzPzogTnhGaWxlVXBsb2FkU3VjY2VzcztcbiAgICAvKiogQWxsIHJlc3VsdHMgd2l0aCBlcnJvcnMuICovXG4gICAgZXJyb3I/OiBOeEZpbGVVcGxvYWRFcnJvcjtcbn1cblxuZXhwb3J0IGNsYXNzIE54RmlsZVVwbG9hZGVyIHtcbiAgICBwcml2YXRlIF9jb25maWc6IE54RmlsZVVwbG9hZENvbmZpZztcbiAgICBwcml2YXRlIF9odHRwQ2xpZW50OiBIdHRwQ2xpZW50O1xuXG4gICAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHRoZSByZXN1bHQgb2YgYW4gdXBsb2FkIHJlcXVlc3QuICovXG4gICAgcmVhZG9ubHkgcmVzcG9uc2U6IFN1YmplY3Q8TnhGaWxlVXBsb2FkUmVzdWx0PiA9IG5ldyBTdWJqZWN0PE54RmlsZVVwbG9hZFJlc3VsdD4oKTtcblxuICAgIC8qKiBTZXRzIHRoZSBjb25maWcgb3B0aW9ucyBmb3IgaHR0cCByZXF1ZXN0cyBmb3IgdXBsb2FkaW5nIHRoZSBmaWxlcy4gKi9cbiAgICBzZXQgY29uZmlnKG9wdGlvbnM6IE54RmlsZVVwbG9hZENvbmZpZykge1xuICAgICAgICBpZiAodGhpcy5fY29uZmlnICE9PSBvcHRpb25zKSB7XG4gICAgICAgICAgICB0aGlzLl9jb25maWcgPSBvcHRpb25zO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldCBjb25maWcoKTogTnhGaWxlVXBsb2FkQ29uZmlnIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZztcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IE54RmlsZVVwbG9hZENvbmZpZywgaHR0cDogSHR0cENsaWVudCkge1xuICAgICAgICB0aGlzLl9jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMuX2h0dHBDbGllbnQgPSBodHRwO1xuICAgIH1cblxuICAgIC8qKiBVcGxvYWRzIHRoZSBmaWxlcyB0byB0aGUgdXJsIHNwZWNpZmllZCBpbiBjb25maWcuICovXG4gICAgdXBsb2FkRmlsZXMoZmlsZXM6IEZpbGVJdGVtW10pIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnWyd1cGxvYWRTZXBhcmF0ZWx5J10pIHtcbiAgICAgICAgICAgIHRoaXMuX3VwbG9hZEZpbGVzU2VwYXJhdGVseShmaWxlcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl91cGxvYWRGaWxlc0NvbGxlY3RpdmVseShmaWxlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogVXBsb2FkcyBhbGwgZmlsZXMgd2l0aCBhIFBPU1QgcmVxdWVzdCB0byB0aGUgdXJsIHNwZWNpZmllZCBpbiBjb25maWcuICovXG4gICAgcHJpdmF0ZSBfdXBsb2FkRmlsZXNDb2xsZWN0aXZlbHkoZmlsZXM6IEZpbGVJdGVtW10pIHtcbiAgICAgICAgLy8gZ2V0IGEgbGlzdCBvZiBhbGwgZmlsZXM7IGlmIHRoZXJlIGlzIG5vIG9uZTogcmV0dXJuXG4gICAgICAgIGlmICghZmlsZXMgfHwgZmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuXG4gICAgICAgIC8vIHNhdmUgdmFsdWUgaGVyZSBpbiBjYXNlIHRoYXQgaXQgY2hhbmdlcyB3aGlsZSByZXF1ZXN0IGlzIHJ1bm5pbmdcbiAgICAgICAgY29uc3QgdmFsdWVzVG9VcGxvYWQgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiAhZmlsZS5pc1VwbG9hZGVkKTtcbiAgICAgICAgdmFsdWVzVG9VcGxvYWQuZm9yRWFjaCgoZmlsZTogRmlsZUl0ZW0pID0+IHtcbiAgICAgICAgICAgIGZpbGUuc2V0VXBsb2FkaW5nU3RhdGUoKTtcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgndXBsb2Fkc1tdJywgZmlsZS5maWxlIGFzIEJsb2IsIGZpbGUubmFtZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX2h0dHBDbGllbnQucG9zdCh0aGlzLmNvbmZpZ1sncmVxdWVzdFVybCddLCBmb3JtRGF0YSwgdGhpcy5jb25maWdbJ29wdGlvbnMnXSkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgdmFsdWVzVG9VcGxvYWQuZm9yRWFjaCgoZmlsZTogRmlsZUl0ZW0pID0+IGZpbGUuc2V0VXBsb2FkZWRTdGF0ZSgpKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc3BvbnNlLm5leHQoeyBhbGxTdWNlc3NmdWw6IHRydWUsIHN1Y2Nlc3M6IG5ldyBOeEZpbGVVcGxvYWRTdWNjZXNzKHZhbHVlc1RvVXBsb2FkLCBbZGF0YV0pIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNUb1VwbG9hZC5mb3JFYWNoKChmaWxlOiBGaWxlSXRlbSkgPT4gZmlsZS5zZXRFcnJvclN0YXRlKCkpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVzcG9uc2UubmV4dCh7IGVycm9yOiBuZXcgTnhGaWxlVXBsb2FkRXJyb3IodmFsdWVzVG9VcGxvYWQsIFtlcnJvcl0pIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGxvYWRzIGFsbCBmaWxlcyB3aXRoIGEgUE9TVCByZXF1ZXN0IHRvIHRoZSB1cmwgc3BlY2lmaWVkIGluIGNvbmZpZy5cbiAgICAgKlxuICAgICAqIEVhY2ggZmlsZSBpcyB1cGxvYWRlZCB3aXRoIGFuIGluZGl2aWR1YWwgcmVxdWVzdC5cbiAgICAgKi9cbiAgICBwcml2YXRlIF91cGxvYWRGaWxlc1NlcGFyYXRlbHkoZmlsZXM6IEZpbGVJdGVtW10pIHtcbiAgICAgICAgLy8gZ2V0IGEgbGlzdCBvZiBhbGwgZmlsZXM7IGlmIHRoZXJlIGlzIG5vIG9uZTogcmV0dXJuXG4gICAgICAgIGlmICghZmlsZXMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlczogT2JzZXJ2YWJsZTxOeEZpbGVVcGxvYWRSZXN1bHQ+W10gPSBbXTtcblxuICAgICAgICBjb25zdCBmaWxlc1RvVXBsb2FkID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gIWZpbGUuaXNVcGxvYWRlZCk7XG5cbiAgICAgICAgZmlsZXNUb1VwbG9hZC5mb3JFYWNoKChmaWxlOiBGaWxlSXRlbSkgPT4ge1xuICAgICAgICAgICAgcmVzcG9uc2VzLnB1c2godGhpcy5fdXBsb2FkRmlsZShmaWxlKS5waXBlKGNhdGNoRXJyb3IoZXJyb3IgPT4gb2YoZXJyb3IpKSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICBmb3JrSm9pbihyZXNwb25zZXMpLnN1YnNjcmliZShyZXN1bHRzID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lcmdlZFJlc3VsdHMgPSByZXN1bHRzLnJlZHVjZSgoYWNjLCByZXN1bHQ6IE54RmlsZVVwbG9hZFJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWFjYy5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Muc3VjY2VzcyA9IG5ldyBOeEZpbGVVcGxvYWRTdWNjZXNzKFtdLCBbXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYWNjLnN1Y2Nlc3MuZmlsZXMucHVzaCguLi5yZXN1bHQuc3VjY2Vzcy5maWxlcyk7XG4gICAgICAgICAgICAgICAgICAgIGFjYy5zdWNjZXNzLnJlcXVlc3RzLnB1c2goLi4ucmVzdWx0LnN1Y2Nlc3MucmVxdWVzdHMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0LmVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWNjLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY2MuZXJyb3IgPSBuZXcgTnhGaWxlVXBsb2FkRXJyb3IoW10sIFtdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhY2MuZXJyb3IuZmlsZXMucHVzaCguLi5yZXN1bHQuZXJyb3IuZmlsZXMpO1xuICAgICAgICAgICAgICAgICAgICBhY2MuZXJyb3IucmVxdWVzdHMucHVzaCguLi5yZXN1bHQuZXJyb3IucmVxdWVzdHMpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgICAgICB9LCB7fSk7XG5cbiAgICAgICAgICAgIGlmICghbWVyZ2VkUmVzdWx0cy5lcnJvcikge1xuICAgICAgICAgICAgICAgIG1lcmdlZFJlc3VsdHMuYWxsU3VjZXNzZnVsID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5yZXNwb25zZS5uZXh0KG1lcmdlZFJlc3VsdHMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKiogVXBsb2FkcyBvbmUgZmlsZSB3aXRoIGEgUE9TVCByZXF1ZXN0IHRvIHRoZSB1cmwgc3BlY2lmaWVkIGluIGNvbmZpZy4gKi9cbiAgICBwcml2YXRlIF91cGxvYWRGaWxlKGZpbGU6IEZpbGVJdGVtKTogU3ViamVjdDxOeEZpbGVVcGxvYWRSZXN1bHQ+IHtcbiAgICAgICAgY29uc3QgZmlsZVJldHVyblZhbDogU3ViamVjdDxOeEZpbGVVcGxvYWRSZXN1bHQ+ID0gbmV3IFN1YmplY3Q8TnhGaWxlVXBsb2FkUmVzdWx0PigpO1xuXG4gICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGlmICghZmlsZS5pc1VwbG9hZGVkKSB7XG4gICAgICAgICAgICBmaWxlLnNldFVwbG9hZGluZ1N0YXRlKCk7XG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3VwbG9hZHNbXScsIGZpbGUuZmlsZSBhcyBCbG9iLCBmaWxlLm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faHR0cENsaWVudC5wb3N0KHRoaXMuY29uZmlnWydyZXF1ZXN0VXJsJ10sIGZvcm1EYXRhLCB0aGlzLmNvbmZpZ1snb3B0aW9ucyddKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICBkYXRhID0+IHtcbiAgICAgICAgICAgICAgICBmaWxlLnNldFVwbG9hZGVkU3RhdGUoKTtcbiAgICAgICAgICAgICAgICBmaWxlUmV0dXJuVmFsLm5leHQoeyBzdWNjZXNzOiBuZXcgTnhGaWxlVXBsb2FkU3VjY2VzcyhbZmlsZV0sIFtkYXRhXSkgfSk7XG4gICAgICAgICAgICAgICAgZmlsZVJldHVyblZhbC5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICBmaWxlLnNldEVycm9yU3RhdGUoKTtcbiAgICAgICAgICAgICAgICBmaWxlUmV0dXJuVmFsLm5leHQoeyBlcnJvcjogbmV3IE54RmlsZVVwbG9hZEVycm9yKFtmaWxlXSwgW2Vycm9yXSkgfSk7XG4gICAgICAgICAgICAgICAgZmlsZVJldHVyblZhbC5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gZmlsZVJldHVyblZhbDtcbiAgICB9XG59XG4iXX0=