import { coerceBooleanProperty, coerceNumberProperty } from '@angular/cdk/coercion';
import { LEFT_ARROW, RIGHT_ARROW, SPACE } from '@angular/cdk/keycodes';
import { ChangeDetectionStrategy, Component, EventEmitter, Input, Optional, Output, ViewChild, } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/bidi";
import * as i2 from "@angular/cdk/a11y";
import * as i3 from "@angular/common";
export const MAX_WIDTH = 400;
export const MIN_WIDTH = 56;
export const AUTO_COLLAPSE_WIDTH = 168;
export const RESIZE_STEP_SIZE = 20;
export class NxSidebarComponent {
    constructor(_cdr, renderer, _element, _dir, _focusMonitor) {
        this._cdr = _cdr;
        this.renderer = renderer;
        this._element = _element;
        this._dir = _dir;
        this._focusMonitor = _focusMonitor;
        /** Emits the new width of the sidebar on resize or on close/open event.*/
        this.widthChange = new EventEmitter();
        this._resizeable = false;
        this._minWidth = MIN_WIDTH;
        this._maxWidth = MAX_WIDTH;
        this._resizeHandleAriaLabel = '';
        this._open = true;
        this._width = 0;
        this._resizing = false;
        this._previousWidth = 0;
        this._isMobile = false;
        this._resizeWidth = 0;
        this._unsubscribeListeners = [];
        this._onResize = this._onResize.bind(this);
        this._onResizeEnd = this._onResizeEnd.bind(this);
    }
    /** If set to `true` this will enable dynamic resizing of the sidebar. */
    set resizeable(value) {
        const newValue = coerceBooleanProperty(value);
        if (newValue !== this._resizeable) {
            this._resizeable = newValue;
            this._cdr.markForCheck();
        }
    }
    get resizeable() {
        return this._resizeable;
    }
    /** Sets the minimal width (in pixel) of the sidebar. */
    set minWidth(value) {
        this._minWidth = coerceNumberProperty(value) || MIN_WIDTH;
    }
    get minWidth() {
        return this._minWidth;
    }
    /** Sets the maximal width (in pixel) of the sidebar. */
    set maxWidth(value) {
        this._maxWidth = coerceNumberProperty(value) || MAX_WIDTH;
    }
    get maxWidth() {
        return this._maxWidth;
    }
    /** This sets the accessibility label for the resize handle of the sidebar. */
    set resizeHandleAriaLabel(value) {
        if (value !== this._resizeHandleAriaLabel) {
            this._resizeHandleAriaLabel = value;
            this._cdr.markForCheck();
        }
    }
    get resizeHandleAriaLabel() {
        return this._resizeHandleAriaLabel;
    }
    /** This reflects the current open state of the sidebar.
      It will be `true` if the sidebar is expanded and `false` if the sidebar is closed.
  */
    set open(value) {
        const newValue = coerceBooleanProperty(value);
        if (newValue !== this._open) {
            this._open = newValue;
            this._cdr.markForCheck();
        }
    }
    get open() {
        return this._open;
    }
    /** This sets the width of the sidebar in an expanded state. */
    set width(value) {
        const newValue = Math.max(value, this.minWidth);
        if (newValue !== this._width) {
            this._width = newValue;
            this._cdr.markForCheck();
        }
    }
    get width() {
        return this._width;
    }
    /** The text direction of the containing app. */
    get dir() {
        return this._dir && this._dir.value === 'rtl' ? 'rtl' : 'ltr';
    }
    ngOnInit() {
        this.width = this._element.nativeElement.clientWidth;
    }
    ngAfterViewInit() {
        if (this.resizeable) {
            this._focusMonitor.monitor(this._resizeHandle);
        }
    }
    ngOnDestroy() {
        this._removeDragEventListeners();
        this._focusMonitor.stopMonitoring(this._resizeHandle);
    }
    /** This will expand the sidebar to its full width. */
    expand(expandedWidth) {
        this.open = true;
        if (expandedWidth) {
            this.width = expandedWidth;
        }
    }
    /** This will close the sidebar to its minimal width. */
    close() {
        this.open = false;
    }
    /** This will close or expand the sidebar depending if it is expanded or closed. */
    toggle() {
        if (this.open) {
            this.close();
        }
        else {
            this.expand();
        }
        this._emitWidthChange(this._sidebarElementWidth);
    }
    get _sidebarElementWidth() {
        if (this._resizing) {
            return this._resizeWidth;
        }
        return this.open ? this.width : this.minWidth;
    }
    _onResizeStart(event) {
        if (event.type.startsWith('touch')) {
            event = event.changedTouches[0];
        }
        this._resizeStartX = event.screenX;
        this._resizeStartWidth = this.open ? this.width : this.minWidth;
        this._resizeWidth = this.width;
        this._attachDragEventListeners();
    }
    _onResize(event) {
        this._resizing = true;
        if (event.type.startsWith('touch')) {
            event = event.changedTouches[0];
        }
        let dx = event.screenX - this._resizeStartX;
        if (this.dir === 'rtl') {
            dx *= -1;
        }
        this._resizeWidth = Math.max(this.minWidth, this._resizeStartWidth + dx);
        this.open = this._resizeWidth > this.minWidth;
        this._cdr.markForCheck();
    }
    _onResizeEnd(event) {
        this._resizing = false;
        this._removeDragEventListeners();
        if (this._isMouseDrag(this._resizeStartX, event.screenX)) {
            if (this._resizeWidth < AUTO_COLLAPSE_WIDTH) {
                this.open = false;
                this._emitWidthChange(this._sidebarElementWidth);
            }
            else {
                this.open = true;
                this.width = Math.min(this._maxWidth, this._resizeWidth);
                this._emitWidthChange(this.width);
            }
        }
        this._resizeWidth = 0;
    }
    _onResizeHandleClick(event) {
        if (this._isMouseDrag(this._resizeStartX, event.screenX)) {
            return;
        }
        this.toggle();
    }
    _onSidebarKeydown(event) {
        if (event.which === SPACE) {
            event.preventDefault();
            this.toggle();
        }
        else if (event.which === LEFT_ARROW) {
            this.width -= RESIZE_STEP_SIZE;
            if (this.width <= AUTO_COLLAPSE_WIDTH) {
                this.open = false;
                this.width = AUTO_COLLAPSE_WIDTH + 1;
            }
            this._emitWidthChange(this.width);
        }
        else if (event.which === RIGHT_ARROW) {
            if (this.open) {
                this.width = Math.min(this._maxWidth, this.width + RESIZE_STEP_SIZE);
            }
            else {
                this.open = true;
                this.width = Math.max(this.width, AUTO_COLLAPSE_WIDTH);
            }
            this._emitWidthChange(this.width);
        }
    }
    _emitWidthChange(width) {
        this.widthChange.emit(width);
    }
    _isMouseDrag(startX, endX) {
        return Math.abs(endX - startX) > 5;
    }
    _attachDragEventListeners() {
        this._unsubscribeListeners.push(this.renderer.listen('document', 'mousemove', this._onResize));
        this._unsubscribeListeners.push(this.renderer.listen('document', 'mouseup', this._onResizeEnd));
        this._unsubscribeListeners.push(this.renderer.listen('document', 'touchmove', this._onResize));
        this._unsubscribeListeners.push(this.renderer.listen('document', 'touchend', this._onResizeEnd));
    }
    _removeDragEventListeners() {
        this._unsubscribeListeners.forEach(unsubscribe => unsubscribe());
    }
}
NxSidebarComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxSidebarComponent, deps: [{ token: i0.ChangeDetectorRef }, { token: i0.Renderer2 }, { token: i0.ElementRef }, { token: i1.Directionality, optional: true }, { token: i2.FocusMonitor }], target: i0.ɵɵFactoryTarget.Component });
NxSidebarComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.1", type: NxSidebarComponent, selector: "nx-sidebar", inputs: { resizeable: "resizeable", minWidth: "minWidth", maxWidth: "maxWidth", resizeHandleAriaLabel: "resizeHandleAriaLabel" }, outputs: { widthChange: "widthChange" }, host: { properties: { "class.is-resizing": "_resizing", "class.is-closed": "!open", "style.width.px": "_sidebarElementWidth" } }, viewQueries: [{ propertyName: "_resizeHandle", first: true, predicate: ["resizeHandle"], descendants: true }], ngImport: i0, template: "<div class=\"nx-sidebar__box\" role=\"tabpanel\" [attr.aria-expanded]=\"open\">\n    <div class=\"nx-sidebar__content\">\n        <ng-content></ng-content>\n    </div>\n    <ng-content select=\"nx-sidebar-footer\"></ng-content>\n</div>\n\n<button\n    #resizeHandle\n    class=\"nx-sidebar__handle\"\n    *ngIf=\"resizeable\"\n    tabindex=\"0\"\n    type=\"button\"\n    (mousedown)=\"_onResizeStart($event)\"\n    (keydown)=\"_onSidebarKeydown($event)\"\n    (touchstart)=\"_onResizeStart($event)\"\n    (click)=\"_onResizeHandleClick($event)\"\n    [attr.aria-label]=\"resizeHandleAriaLabel\"\n>\n</button>\n", styles: [":host{position:relative;height:100%;transition:width .15s ease;display:flex;flex:0 0 auto;width:280px}:host.is-resizing{transition:none}@media (max-width: 703px){:host{width:100%;transition:none}:host .nx-sidebar__handle{display:none}}:host.is-closed ::ng-deep .nx-sidebar__toggle-button{transform:rotate(180deg)}:host.is-closed ::ng-deep .nx-sidebar__footer-container{flex-direction:column;align-items:center}::ng-deep .nx-sidebar__footer{padding-bottom:8px;display:flex;justify-content:flex-end;color:var(--sidebar-footer-button-color)}::ng-deep .nx-sidebar__footer:before,::ng-deep .nx-sidebar__footer:after{content:\"\";display:block;flex:0 1 22px;min-width:8px;height:1px}::ng-deep .nx-sidebar__footer:after{flex:0 1 16px}::ng-deep .nx-sidebar__footer-container{display:flex;flex:1 1 auto;flex-direction:row}.nx-sidebar__handle{position:absolute;right:-14px;top:0;bottom:0;display:flex;flex:0 0 16px;justify-content:center;align-items:center;-webkit-appearance:none;appearance:none;border:none;box-shadow:none;background:none;margin:0;cursor:col-resize;outline:none;z-index:1;color:var(--sidebar-handle-color)}:host-context([dir=rtl]) .nx-sidebar__handle{right:auto;left:-15px}.nx-sidebar__handle:before{content:\"||\";font-size:14px;letter-spacing:-1px;font-weight:600;color:inherit}@media screen and (-ms-high-contrast: active){.nx-sidebar__handle:before{-ms-high-contrast-adjust:none;color:buttonText;background-color:buttonFace;box-shadow:0 0 0 6px buttonFace,0 0 0 8px buttonText}}.nx-sidebar__handle::-moz-focus-inner{border:0}.nx-sidebar__handle.cdk-keyboard-focused:before{border-radius:4px;padding-right:1px;box-shadow:var(--focus-box-shadow)}@media screen and (-ms-high-contrast: active),(forced-colors: active){.nx-sidebar__handle.cdk-keyboard-focused:before{box-shadow:0 0 0 2px background,0 0 0 6px windowText;outline:4px solid CanvasText;outline-offset:2px}}[dir=rtl] .nx-sidebar__handle.cdk-keyboard-focused:before{padding-right:0;padding-right:initial;padding-left:1px}.nx-sidebar__box{height:100%;flex:1 1 100%;display:flex;overflow:hidden;flex-direction:column;background:var(--sidebar-background-color)}@media screen and (-ms-high-contrast: active){.nx-sidebar__box{border-right:1px solid windowText}:host-context([dir=rtl]) .nx-sidebar__box{border-right:none;border-left:1px solid windowText}}.nx-sidebar__content{flex:1 1 100%;overflow:hidden;overflow-y:auto;padding-top:16px}.nx-sidebar__content:only-child{padding-bottom:16px}\n"], directives: [{ type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.1", ngImport: i0, type: NxSidebarComponent, decorators: [{
            type: Component,
            args: [{ selector: 'nx-sidebar', changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        '[class.is-resizing]': '_resizing',
                        '[class.is-closed]': '!open',
                        '[style.width.px]': `_sidebarElementWidth`,
                    }, template: "<div class=\"nx-sidebar__box\" role=\"tabpanel\" [attr.aria-expanded]=\"open\">\n    <div class=\"nx-sidebar__content\">\n        <ng-content></ng-content>\n    </div>\n    <ng-content select=\"nx-sidebar-footer\"></ng-content>\n</div>\n\n<button\n    #resizeHandle\n    class=\"nx-sidebar__handle\"\n    *ngIf=\"resizeable\"\n    tabindex=\"0\"\n    type=\"button\"\n    (mousedown)=\"_onResizeStart($event)\"\n    (keydown)=\"_onSidebarKeydown($event)\"\n    (touchstart)=\"_onResizeStart($event)\"\n    (click)=\"_onResizeHandleClick($event)\"\n    [attr.aria-label]=\"resizeHandleAriaLabel\"\n>\n</button>\n", styles: [":host{position:relative;height:100%;transition:width .15s ease;display:flex;flex:0 0 auto;width:280px}:host.is-resizing{transition:none}@media (max-width: 703px){:host{width:100%;transition:none}:host .nx-sidebar__handle{display:none}}:host.is-closed ::ng-deep .nx-sidebar__toggle-button{transform:rotate(180deg)}:host.is-closed ::ng-deep .nx-sidebar__footer-container{flex-direction:column;align-items:center}::ng-deep .nx-sidebar__footer{padding-bottom:8px;display:flex;justify-content:flex-end;color:var(--sidebar-footer-button-color)}::ng-deep .nx-sidebar__footer:before,::ng-deep .nx-sidebar__footer:after{content:\"\";display:block;flex:0 1 22px;min-width:8px;height:1px}::ng-deep .nx-sidebar__footer:after{flex:0 1 16px}::ng-deep .nx-sidebar__footer-container{display:flex;flex:1 1 auto;flex-direction:row}.nx-sidebar__handle{position:absolute;right:-14px;top:0;bottom:0;display:flex;flex:0 0 16px;justify-content:center;align-items:center;-webkit-appearance:none;appearance:none;border:none;box-shadow:none;background:none;margin:0;cursor:col-resize;outline:none;z-index:1;color:var(--sidebar-handle-color)}:host-context([dir=rtl]) .nx-sidebar__handle{right:auto;left:-15px}.nx-sidebar__handle:before{content:\"||\";font-size:14px;letter-spacing:-1px;font-weight:600;color:inherit}@media screen and (-ms-high-contrast: active){.nx-sidebar__handle:before{-ms-high-contrast-adjust:none;color:buttonText;background-color:buttonFace;box-shadow:0 0 0 6px buttonFace,0 0 0 8px buttonText}}.nx-sidebar__handle::-moz-focus-inner{border:0}.nx-sidebar__handle.cdk-keyboard-focused:before{border-radius:4px;padding-right:1px;box-shadow:var(--focus-box-shadow)}@media screen and (-ms-high-contrast: active),(forced-colors: active){.nx-sidebar__handle.cdk-keyboard-focused:before{box-shadow:0 0 0 2px background,0 0 0 6px windowText;outline:4px solid CanvasText;outline-offset:2px}}[dir=rtl] .nx-sidebar__handle.cdk-keyboard-focused:before{padding-right:0;padding-right:initial;padding-left:1px}.nx-sidebar__box{height:100%;flex:1 1 100%;display:flex;overflow:hidden;flex-direction:column;background:var(--sidebar-background-color)}@media screen and (-ms-high-contrast: active){.nx-sidebar__box{border-right:1px solid windowText}:host-context([dir=rtl]) .nx-sidebar__box{border-right:none;border-left:1px solid windowText}}.nx-sidebar__content{flex:1 1 100%;overflow:hidden;overflow-y:auto;padding-top:16px}.nx-sidebar__content:only-child{padding-bottom:16px}\n"] }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }, { type: i0.Renderer2 }, { type: i0.ElementRef }, { type: i1.Directionality, decorators: [{
                    type: Optional
                }] }, { type: i2.FocusMonitor }]; }, propDecorators: { _resizeHandle: [{
                type: ViewChild,
                args: ['resizeHandle']
            }], widthChange: [{
                type: Output
            }], resizeable: [{
                type: Input
            }], minWidth: [{
                type: Input
            }], maxWidth: [{
                type: Input
            }], resizeHandleAriaLabel: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lkZWJhci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1hcXVpbGEvc3JjL3NpZGViYXIvc2lkZWJhci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1hcXVpbGEvc3JjL3NpZGViYXIvc2lkZWJhci5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQWdCLHFCQUFxQixFQUFFLG9CQUFvQixFQUFlLE1BQU0sdUJBQXVCLENBQUM7QUFDL0csT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdkUsT0FBTyxFQUVILHVCQUF1QixFQUV2QixTQUFTLEVBRVQsWUFBWSxFQUNaLEtBQUssRUFHTCxRQUFRLEVBQ1IsTUFBTSxFQUVOLFNBQVMsR0FDWixNQUFNLGVBQWUsQ0FBQzs7Ozs7QUFFdkIsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQztBQUM3QixNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBQzVCLE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLEdBQUcsQ0FBQztBQUN2QyxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFhbkMsTUFBTSxPQUFPLGtCQUFrQjtJQXdHM0IsWUFDWSxJQUF1QixFQUN2QixRQUFtQixFQUNuQixRQUFvQixFQUNSLElBQTJCLEVBQ3ZDLGFBQTJCO1FBSjNCLFNBQUksR0FBSixJQUFJLENBQW1CO1FBQ3ZCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUNSLFNBQUksR0FBSixJQUFJLENBQXVCO1FBQ3ZDLGtCQUFhLEdBQWIsYUFBYSxDQUFjO1FBMUd2QywwRUFBMEU7UUFDaEUsZ0JBQVcsR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQWVq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O3FCQUM3Qzs7MEJBOEdJLFFBQVE7dUVBM0djLGFBQWE7c0JBQXZDLFNBQVM7dUJBQUMsY0FBYztnQkFHZixXQUFXO3NCQUFwQixNQUFNO2dCQUlILFVBQVU7c0JBRGIsS0FBSztnQkFnQkYsUUFBUTtzQkFEWCxLQUFLO2dCQVdGLFFBQVE7c0JBRFgsS0FBSztnQkFXRixxQkFBcUI7c0JBRHhCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb2N1c01vbml0b3IgfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG5pbXBvcnQgeyBEaXJlY3Rpb24sIERpcmVjdGlvbmFsaXR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2JpZGknO1xuaW1wb3J0IHsgQm9vbGVhbklucHV0LCBjb2VyY2VCb29sZWFuUHJvcGVydHksIGNvZXJjZU51bWJlclByb3BlcnR5LCBOdW1iZXJJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQgeyBMRUZUX0FSUk9XLCBSSUdIVF9BUlJPVywgU1BBQ0UgfSBmcm9tICdAYW5ndWxhci9jZGsva2V5Y29kZXMnO1xuaW1wb3J0IHtcbiAgICBBZnRlclZpZXdJbml0LFxuICAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICAgIENoYW5nZURldGVjdG9yUmVmLFxuICAgIENvbXBvbmVudCxcbiAgICBFbGVtZW50UmVmLFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBJbnB1dCxcbiAgICBPbkRlc3Ryb3ksXG4gICAgT25Jbml0LFxuICAgIE9wdGlvbmFsLFxuICAgIE91dHB1dCxcbiAgICBSZW5kZXJlcjIsXG4gICAgVmlld0NoaWxkLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuZXhwb3J0IGNvbnN0IE1BWF9XSURUSCA9IDQwMDtcbmV4cG9ydCBjb25zdCBNSU5fV0lEVEggPSA1NjtcbmV4cG9ydCBjb25zdCBBVVRPX0NPTExBUFNFX1dJRFRIID0gMTY4O1xuZXhwb3J0IGNvbnN0IFJFU0laRV9TVEVQX1NJWkUgPSAyMDtcblxuQENvbXBvbmVudCh7XG4gICAgdGVtcGxhdGVVcmw6ICcuL3NpZGViYXIuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWydzaWRlYmFyLnNjc3MnXSxcbiAgICBzZWxlY3RvcjogJ254LXNpZGViYXInLFxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICAgIGhvc3Q6IHtcbiAgICAgICAgJ1tjbGFzcy5pcy1yZXNpemluZ10nOiAnX3Jlc2l6aW5nJyxcbiAgICAgICAgJ1tjbGFzcy5pcy1jbG9zZWRdJzogJyFvcGVuJyxcbiAgICAgICAgJ1tzdHlsZS53aWR0aC5weF0nOiBgX3NpZGViYXJFbGVtZW50V2lkdGhgLFxuICAgIH0sXG59KVxuZXhwb3J0IGNsYXNzIE54U2lkZWJhckNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSwgT25Jbml0IHtcbiAgICBAVmlld0NoaWxkKCdyZXNpemVIYW5kbGUnKSBfcmVzaXplSGFuZGxlITogRWxlbWVudFJlZjtcblxuICAgIC8qKiBFbWl0cyB0aGUgbmV3IHdpZHRoIG9mIHRoZSBzaWRlYmFyIG9uIHJlc2l6ZSBvciBvbiBjbG9zZS9vcGVuIGV2ZW50LiovXG4gICAgQE91dHB1dCgpIHdpZHRoQ2hhbmdlOiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xuXG4gICAgLyoqIElmIHNldCB0byBgdHJ1ZWAgdGhpcyB3aWxsIGVuYWJsZSBkeW5hbWljIHJlc2l6aW5nIG9mIHRoZSBzaWRlYmFyLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2V0IHJlc2l6ZWFibGUodmFsdWU6IEJvb2xlYW5JbnB1dCkge1xuICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSh2YWx1ZSk7XG5cbiAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSB0aGlzLl9yZXNpemVhYmxlKSB7XG4gICAgICAgICAgICB0aGlzLl9yZXNpemVhYmxlID0gbmV3VmFsdWU7XG4gICAgICAgICAgICB0aGlzLl9jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZ2V0IHJlc2l6ZWFibGUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9yZXNpemVhYmxlO1xuICAgIH1cbiAgICBwcml2YXRlIF9yZXNpemVhYmxlID0gZmFsc2U7XG5cbiAgICAvKiogU2V0cyB0aGUgbWluaW1hbCB3aWR0aCAoaW4gcGl4ZWwpIG9mIHRoZSBzaWRlYmFyLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2V0IG1pbldpZHRoKHZhbHVlOiBOdW1iZXJJbnB1dCkge1xuICAgICAgICB0aGlzLl9taW5XaWR0aCA9IGNvZXJjZU51bWJlclByb3BlcnR5KHZhbHVlKSB8fCBNSU5fV0lEVEg7XG4gICAgfVxuICAgIGdldCBtaW5XaWR0aCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fbWluV2lkdGg7XG4gICAgfVxuICAgIHByaXZhdGUgX21pbldpZHRoOiBudW1iZXIgPSBNSU5fV0lEVEg7XG5cbiAgICAvKiogU2V0cyB0aGUgbWF4aW1hbCB3aWR0aCAoaW4gcGl4ZWwpIG9mIHRoZSBzaWRlYmFyLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2V0IG1heFdpZHRoKHZhbHVlOiBOdW1iZXJJbnB1dCkge1xuICAgICAgICB0aGlzLl9tYXhXaWR0aCA9IGNvZXJjZU51bWJlclByb3BlcnR5KHZhbHVlKSB8fCBNQVhfV0lEVEg7XG4gICAgfVxuICAgIGdldCBtYXhXaWR0aCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fbWF4V2lkdGg7XG4gICAgfVxuICAgIHByaXZhdGUgX21heFdpZHRoOiBudW1iZXIgPSBNQVhfV0lEVEg7XG5cbiAgICAvKiogVGhpcyBzZXRzIHRoZSBhY2Nlc3NpYmlsaXR5IGxhYmVsIGZvciB0aGUgcmVzaXplIGhhbmRsZSBvZiB0aGUgc2lkZWJhci4gKi9cbiAgICBASW5wdXQoKVxuICAgIHNldCByZXNpemVIYW5kbGVBcmlhTGFiZWwodmFsdWU6IHN0cmluZykge1xuICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3Jlc2l6ZUhhbmRsZUFyaWFMYWJlbCkge1xuICAgICAgICAgICAgdGhpcy5fcmVzaXplSGFuZGxlQXJpYUxhYmVsID0gdmFsdWU7XG4gICAgICAgICAgICB0aGlzLl9jZHIubWFya0ZvckNoZWNrKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZ2V0IHJlc2l6ZUhhbmRsZUFyaWFMYWJlbCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Jlc2l6ZUhhbmRsZUFyaWFMYWJlbDtcbiAgICB9XG4gICAgcHJpdmF0ZSBfcmVzaXplSGFuZGxlQXJpYUxhYmVsID0gJyc7XG5cbiAgICAvKiogVGhpcyByZWZsZWN0cyB0aGUgY3VycmVudCBvcGVuIHN0YXRlIG9mIHRoZSBzaWRlYmFyLlxuICAgICAgSXQgd2lsbCBiZSBgdHJ1ZWAgaWYgdGhlIHNpZGViYXIgaXMgZXhwYW5kZWQgYW5kIGBmYWxzZWAgaWYgdGhlIHNpZGViYXIgaXMgY2xvc2VkLlxuICAqL1xuICAgIHNldCBvcGVuKHZhbHVlOiBCb29sZWFuSW5wdXQpIHtcbiAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkodmFsdWUpO1xuXG4gICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gdGhpcy5fb3Blbikge1xuICAgICAgICAgICAgdGhpcy5fb3BlbiA9IG5ld1ZhbHVlO1xuICAgICAgICAgICAgdGhpcy5fY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldCBvcGVuKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fb3BlbjtcbiAgICB9XG4gICAgcHJpdmF0ZSBfb3BlbiA9IHRydWU7XG5cbiAgICAvKiogVGhpcyBzZXRzIHRoZSB3aWR0aCBvZiB0aGUgc2lkZWJhciBpbiBhbiBleHBhbmRlZCBzdGF0ZS4gKi9cbiAgICBzZXQgd2lkdGgodmFsdWU6IG51bWJlcikge1xuICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IE1hdGgubWF4KHZhbHVlLCB0aGlzLm1pbldpZHRoKTtcblxuICAgICAgICBpZiAobmV3VmFsdWUgIT09IHRoaXMuX3dpZHRoKSB7XG4gICAgICAgICAgICB0aGlzLl93aWR0aCA9IG5ld1ZhbHVlO1xuICAgICAgICAgICAgdGhpcy5fY2RyLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldCB3aWR0aCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fd2lkdGg7XG4gICAgfVxuXG4gICAgLyoqIFRoZSB0ZXh0IGRpcmVjdGlvbiBvZiB0aGUgY29udGFpbmluZyBhcHAuICovXG4gICAgZ2V0IGRpcigpOiBEaXJlY3Rpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGlyICYmIHRoaXMuX2Rpci52YWx1ZSA9PT0gJ3J0bCcgPyAncnRsJyA6ICdsdHInO1xuICAgIH1cblxuICAgIF93aWR0aCA9IDA7XG5cbiAgICBfcmVzaXppbmcgPSBmYWxzZTtcblxuICAgIF9wcmV2aW91c1dpZHRoID0gMDtcblxuICAgIF9pc01vYmlsZSA9IGZhbHNlO1xuXG4gICAgX3Jlc2l6ZVdpZHRoID0gMDtcblxuICAgIHByaXZhdGUgX3Jlc2l6ZVN0YXJ0WCE6IG51bWJlcjtcblxuICAgIHByaXZhdGUgX3Jlc2l6ZVN0YXJ0V2lkdGghOiBudW1iZXI7XG5cbiAgICBwcml2YXRlIF91bnN1YnNjcmliZUxpc3RlbmVyczogKCgpID0+IHZvaWQpW10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIF9jZHI6IENoYW5nZURldGVjdG9yUmVmLFxuICAgICAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgICAgIHByaXZhdGUgX2VsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgICAgIEBPcHRpb25hbCgpIHByaXZhdGUgX2RpcjogRGlyZWN0aW9uYWxpdHkgfCBudWxsLFxuICAgICAgICBwcml2YXRlIF9mb2N1c01vbml0b3I6IEZvY3VzTW9uaXRvcixcbiAgICApIHtcbiAgICAgICAgdGhpcy5fb25SZXNpemUgPSB0aGlzLl9vblJlc2l6ZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLl9vblJlc2l6ZUVuZCA9IHRoaXMuX29uUmVzaXplRW5kLmJpbmQodGhpcyk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMud2lkdGggPSB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuY2xpZW50V2lkdGg7XG4gICAgfVxuXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgICAgICBpZiAodGhpcy5yZXNpemVhYmxlKSB7XG4gICAgICAgICAgICB0aGlzLl9mb2N1c01vbml0b3IubW9uaXRvcih0aGlzLl9yZXNpemVIYW5kbGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuX3JlbW92ZURyYWdFdmVudExpc3RlbmVycygpO1xuICAgICAgICB0aGlzLl9mb2N1c01vbml0b3Iuc3RvcE1vbml0b3JpbmcodGhpcy5fcmVzaXplSGFuZGxlKTtcbiAgICB9XG5cbiAgICAvKiogVGhpcyB3aWxsIGV4cGFuZCB0aGUgc2lkZWJhciB0byBpdHMgZnVsbCB3aWR0aC4gKi9cbiAgICBleHBhbmQoZXhwYW5kZWRXaWR0aD86IG51bWJlcikge1xuICAgICAgICB0aGlzLm9wZW4gPSB0cnVlO1xuICAgICAgICBpZiAoZXhwYW5kZWRXaWR0aCkge1xuICAgICAgICAgICAgdGhpcy53aWR0aCA9IGV4cGFuZGVkV2lkdGg7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogVGhpcyB3aWxsIGNsb3NlIHRoZSBzaWRlYmFyIHRvIGl0cyBtaW5pbWFsIHdpZHRoLiAqL1xuICAgIGNsb3NlKCkge1xuICAgICAgICB0aGlzLm9wZW4gPSBmYWxzZTtcbiAgICB9XG5cbiAgICAvKiogVGhpcyB3aWxsIGNsb3NlIG9yIGV4cGFuZCB0aGUgc2lkZWJhciBkZXBlbmRpbmcgaWYgaXQgaXMgZXhwYW5kZWQgb3IgY2xvc2VkLiAqL1xuICAgIHRvZ2dsZSgpIHtcbiAgICAgICAgaWYgKHRoaXMub3Blbikge1xuICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5leHBhbmQoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9lbWl0V2lkdGhDaGFuZ2UodGhpcy5fc2lkZWJhckVsZW1lbnRXaWR0aCk7XG4gICAgfVxuXG4gICAgZ2V0IF9zaWRlYmFyRWxlbWVudFdpZHRoKCkge1xuICAgICAgICBpZiAodGhpcy5fcmVzaXppbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZXNpemVXaWR0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLm9wZW4gPyB0aGlzLndpZHRoIDogdGhpcy5taW5XaWR0aDtcbiAgICB9XG5cbiAgICBfb25SZXNpemVTdGFydChldmVudDogYW55KSB7XG4gICAgICAgIGlmIChldmVudC50eXBlLnN0YXJ0c1dpdGgoJ3RvdWNoJykpIHtcbiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF07XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9yZXNpemVTdGFydFggPSBldmVudC5zY3JlZW5YO1xuICAgICAgICB0aGlzLl9yZXNpemVTdGFydFdpZHRoID0gdGhpcy5vcGVuID8gdGhpcy53aWR0aCA6IHRoaXMubWluV2lkdGg7XG4gICAgICAgIHRoaXMuX3Jlc2l6ZVdpZHRoID0gdGhpcy53aWR0aDtcblxuICAgICAgICB0aGlzLl9hdHRhY2hEcmFnRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICB9XG5cbiAgICBfb25SZXNpemUoZXZlbnQ6IGFueSkge1xuICAgICAgICB0aGlzLl9yZXNpemluZyA9IHRydWU7XG5cbiAgICAgICAgaWYgKGV2ZW50LnR5cGUuc3RhcnRzV2l0aCgndG91Y2gnKSkge1xuICAgICAgICAgICAgZXZlbnQgPSBldmVudC5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBkeCA9IGV2ZW50LnNjcmVlblggLSB0aGlzLl9yZXNpemVTdGFydFg7XG4gICAgICAgIGlmICh0aGlzLmRpciA9PT0gJ3J0bCcpIHtcbiAgICAgICAgICAgIGR4ICo9IC0xO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fcmVzaXplV2lkdGggPSBNYXRoLm1heCh0aGlzLm1pbldpZHRoLCB0aGlzLl9yZXNpemVTdGFydFdpZHRoICsgZHgpO1xuICAgICAgICB0aGlzLm9wZW4gPSB0aGlzLl9yZXNpemVXaWR0aCA+IHRoaXMubWluV2lkdGg7XG4gICAgICAgIHRoaXMuX2Nkci5tYXJrRm9yQ2hlY2soKTtcbiAgICB9XG5cbiAgICBfb25SZXNpemVFbmQoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgdGhpcy5fcmVzaXppbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fcmVtb3ZlRHJhZ0V2ZW50TGlzdGVuZXJzKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2lzTW91c2VEcmFnKHRoaXMuX3Jlc2l6ZVN0YXJ0WCwgZXZlbnQuc2NyZWVuWCkpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9yZXNpemVXaWR0aCA8IEFVVE9fQ09MTEFQU0VfV0lEVEgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLl9lbWl0V2lkdGhDaGFuZ2UodGhpcy5fc2lkZWJhckVsZW1lbnRXaWR0aCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMub3BlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy53aWR0aCA9IE1hdGgubWluKHRoaXMuX21heFdpZHRoLCB0aGlzLl9yZXNpemVXaWR0aCk7XG4gICAgICAgICAgICAgICAgdGhpcy5fZW1pdFdpZHRoQ2hhbmdlKHRoaXMud2lkdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3Jlc2l6ZVdpZHRoID0gMDtcbiAgICB9XG5cbiAgICBfb25SZXNpemVIYW5kbGVDbGljayhldmVudDogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAodGhpcy5faXNNb3VzZURyYWcodGhpcy5fcmVzaXplU3RhcnRYLCBldmVudC5zY3JlZW5YKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy50b2dnbGUoKTtcbiAgICB9XG5cbiAgICBfb25TaWRlYmFyS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICBpZiAoZXZlbnQud2hpY2ggPT09IFNQQUNFKSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgdGhpcy50b2dnbGUoKTtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC53aGljaCA9PT0gTEVGVF9BUlJPVykge1xuICAgICAgICAgICAgdGhpcy53aWR0aCAtPSBSRVNJWkVfU1RFUF9TSVpFO1xuXG4gICAgICAgICAgICBpZiAodGhpcy53aWR0aCA8PSBBVVRPX0NPTExBUFNFX1dJRFRIKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy53aWR0aCA9IEFVVE9fQ09MTEFQU0VfV0lEVEggKyAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fZW1pdFdpZHRoQ2hhbmdlKHRoaXMud2lkdGgpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LndoaWNoID09PSBSSUdIVF9BUlJPVykge1xuICAgICAgICAgICAgaWYgKHRoaXMub3Blbikge1xuICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSBNYXRoLm1pbih0aGlzLl9tYXhXaWR0aCwgdGhpcy53aWR0aCArIFJFU0laRV9TVEVQX1NJWkUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSBNYXRoLm1heCh0aGlzLndpZHRoLCBBVVRPX0NPTExBUFNFX1dJRFRIKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2VtaXRXaWR0aENoYW5nZSh0aGlzLndpZHRoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2VtaXRXaWR0aENoYW5nZSh3aWR0aDogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMud2lkdGhDaGFuZ2UuZW1pdCh3aWR0aCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaXNNb3VzZURyYWcoc3RhcnRYOiBudW1iZXIsIGVuZFg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gTWF0aC5hYnMoZW5kWCAtIHN0YXJ0WCkgPiA1O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2F0dGFjaERyYWdFdmVudExpc3RlbmVycygpIHtcbiAgICAgICAgdGhpcy5fdW5zdWJzY3JpYmVMaXN0ZW5lcnMucHVzaCh0aGlzLnJlbmRlcmVyLmxpc3RlbignZG9jdW1lbnQnLCAnbW91c2Vtb3ZlJywgdGhpcy5fb25SZXNpemUpKTtcbiAgICAgICAgdGhpcy5fdW5zdWJzY3JpYmVMaXN0ZW5lcnMucHVzaCh0aGlzLnJlbmRlcmVyLmxpc3RlbignZG9jdW1lbnQnLCAnbW91c2V1cCcsIHRoaXMuX29uUmVzaXplRW5kKSk7XG4gICAgICAgIHRoaXMuX3Vuc3Vic2NyaWJlTGlzdGVuZXJzLnB1c2godGhpcy5yZW5kZXJlci5saXN0ZW4oJ2RvY3VtZW50JywgJ3RvdWNobW92ZScsIHRoaXMuX29uUmVzaXplKSk7XG4gICAgICAgIHRoaXMuX3Vuc3Vic2NyaWJlTGlzdGVuZXJzLnB1c2godGhpcy5yZW5kZXJlci5saXN0ZW4oJ2RvY3VtZW50JywgJ3RvdWNoZW5kJywgdGhpcy5fb25SZXNpemVFbmQpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9yZW1vdmVEcmFnRXZlbnRMaXN0ZW5lcnMoKSB7XG4gICAgICAgIHRoaXMuX3Vuc3Vic2NyaWJlTGlzdGVuZXJzLmZvckVhY2godW5zdWJzY3JpYmUgPT4gdW5zdWJzY3JpYmUoKSk7XG4gICAgfVxufVxuIiwiPGRpdiBjbGFzcz1cIm54LXNpZGViYXJfX2JveFwiIHJvbGU9XCJ0YWJwYW5lbFwiIFthdHRyLmFyaWEtZXhwYW5kZWRdPVwib3BlblwiPlxuICAgIDxkaXYgY2xhc3M9XCJueC1zaWRlYmFyX19jb250ZW50XCI+XG4gICAgICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cbiAgICA8L2Rpdj5cbiAgICA8bmctY29udGVudCBzZWxlY3Q9XCJueC1zaWRlYmFyLWZvb3RlclwiPjwvbmctY29udGVudD5cbjwvZGl2PlxuXG48YnV0dG9uXG4gICAgI3Jlc2l6ZUhhbmRsZVxuICAgIGNsYXNzPVwibngtc2lkZWJhcl9faGFuZGxlXCJcbiAgICAqbmdJZj1cInJlc2l6ZWFibGVcIlxuICAgIHRhYmluZGV4PVwiMFwiXG4gICAgdHlwZT1cImJ1dHRvblwiXG4gICAgKG1vdXNlZG93bik9XCJfb25SZXNpemVTdGFydCgkZXZlbnQpXCJcbiAgICAoa2V5ZG93bik9XCJfb25TaWRlYmFyS2V5ZG93bigkZXZlbnQpXCJcbiAgICAodG91Y2hzdGFydCk9XCJfb25SZXNpemVTdGFydCgkZXZlbnQpXCJcbiAgICAoY2xpY2spPVwiX29uUmVzaXplSGFuZGxlQ2xpY2soJGV2ZW50KVwiXG4gICAgW2F0dHIuYXJpYS1sYWJlbF09XCJyZXNpemVIYW5kbGVBcmlhTGFiZWxcIlxuPlxuPC9idXR0b24+XG4iXX0=